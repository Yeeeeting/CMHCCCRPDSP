<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CCC實務工作坊演練平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --primary-teal: #0d9488;
            --primary-indigo: #4f46e5;
            --primary-adapt: #ED7D31;
            --bg-slate: #f8fafc;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-slate); 
            line-height: 1.6; 
            -webkit-tap-highlight-color: transparent;
            font-size: 16px; 
            color: #334155;
            height: 100vh;
            overflow: hidden;
            transition: background 0.8s ease;
            background-attachment: fixed;
            background-size: cover;
        }

        /* === 主題背景設定 === */
        body.theme-ccc { background: radial-gradient(circle at 0% 0%, #f0fdfa 0%, #f8fafc 60%); }
        body.theme-remediation { background: radial-gradient(circle at 0% 0%, #eef2ff 0%, #f8fafc 60%); }
        body.theme-adapt { background: radial-gradient(circle at 0% 0%, #fff7ed 0%, #f8fafc 60%); }

        /* === Header === */
        .header-container { position: relative; z-index: 50; border-bottom: 1px solid rgba(255,255,255,0.3); box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); transition: all 0.5s ease; }
        .header-bg-layer { position: absolute; inset: 0; z-index: -1; transition: opacity 0.5s ease; overflow: hidden; }
        body.theme-ccc .header-bg-layer { background: linear-gradient(120deg, #ccfbf1 0%, #ffffff 100%); }
        body.theme-remediation .header-bg-layer { background: linear-gradient(120deg, #e0e7ff 0%, #ffffff 100%); }
        body.theme-adapt .header-bg-layer { background: linear-gradient(120deg, #ffedd5 0%, #ffffff 100%); }

        /* === 浮水印 === */
        .bg-watermark {
            position: fixed; bottom: -5%; right: -5%; width: 65vh; height: 65vh;
            background-image: url('https://raw.githubusercontent.com/Yeeeeting/CMHCCCRPDSP/main/LOGO-BLUE.png');
            background-repeat: no-repeat; background-position: center; background-size: contain;
            opacity: 0.08; z-index: 0; pointer-events: none; transform: rotate(-10deg); filter: grayscale(10%); transition: all 0.8s ease;
        }
        body.theme-adapt .bg-watermark { transform: rotate(0deg) scale(1.05); opacity: 0.07; }

        /* === 通用元件 === */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 4px; }
        textarea:focus, input:focus { outline: none; border-color: var(--primary-indigo); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); background-color: #fff; }

        /* Dashboard Card */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; z-index: 10;
        }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.08); background: rgba(255, 255, 255, 0.9); }

        /* Navigation */
        .nav-pill { position: relative; padding: 0.8rem 1.5rem; font-weight: 700; font-size: 1rem; color: #64748b; transition: color 0.3s; cursor: pointer; white-space: nowrap; }
        .nav-pill.active { color: #0f172a; }
        .nav-pill.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 4px; background: currentColor; border-radius: 3px 3px 0 0; }

        /* Sidebar & Steps */
        .sidebar-item { padding: 0.85rem 1.25rem; border-left: 4px solid transparent; cursor: pointer; transition: all 0.2s ease; }
        .sidebar-item:hover { background-color: #f8fafc; }
        .sidebar-item.active { background-color: #f0fdfa; border-left-color: #0d9488; }
        .step-pill { flex: 0 0 auto; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.9rem; font-weight: 600; color: #64748b; background: #f1f5f9; border: 1px solid #e2e8f0; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
        .step-pill.active { background: #0f766e; color: white; border-color: #0f766e; }

        /* Loading */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0d9488; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sync-spin { animation: spin 1.5s linear infinite; }

        /* ADAPT Custom */
        .text-adapt { color: #ED7D31; }
        .bg-adapt { background-color: #ED7D31; }
        .hover-bg-adapt:hover { background-color: #d06015; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-800 theme-ccc">

    <div class="bg-watermark"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <div class="text-xl font-bold text-slate-600">正在同步資料庫...</div>
        <div class="text-sm text-slate-400 mt-2">請稍候，正在讀取最新的演練進度</div>
    </div>

    <!-- Header -->
    <header class="header-container flex-shrink-0">
        <div class="header-bg-layer"></div>
        <div class="w-full px-6 h-24 flex items-center justify-between relative z-10">
            <div class="flex items-center gap-5">
                <div id="app-icon" class="w-16 h-16 rounded-2xl bg-teal-600 text-white flex items-center justify-center shadow-lg transition-colors duration-500 transform hover:scale-105">
                    <i class="fa-solid fa-user-doctor text-4xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-slate-800 leading-tight drop-shadow-sm">CCC實務工作坊演練平台</h1>
                    <div class="text-sm text-slate-500 font-bold tracking-wider mt-1 opacity-80">CCC X REMEDIATION X Structured Feedback</div>
                </div>
            </div>
            <div class="flex items-center gap-5">
                <div id="sync-status" class="text-slate-400 text-sm flex items-center gap-2 transition-colors font-medium bg-white/50 px-3 py-1 rounded-full">
                    <i class="fa-solid fa-cloud"></i> <span id="sync-text">就緒</span>
                </div>
                <div class="bg-white/80 backdrop-blur-md px-6 py-3 rounded-full text-2xl font-mono font-bold text-slate-700 border border-slate-200/60 flex items-center gap-3 shadow-sm">
                    <i class="fa-regular fa-clock text-slate-400"></i> <span id="global-timer">00:00</span>
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="bg-white/40 backdrop-blur-md border-t border-white/50">
            <div class="w-full px-6 flex gap-6 overflow-x-auto no-scrollbar py-1">
                <button onclick="app.switchModule('ccc')" id="tab-ccc" class="nav-pill active text-teal-800 border-teal-600">
                    <i class="fa-solid fa-people-group mr-2"></i> CCC 演練
                </button>
                <button onclick="app.switchModule('remediation')" id="tab-remediation" class="nav-pill text-slate-500">
                    <i class="fa-solid fa-clipboard-list mr-2"></i> 補強計畫
                </button>
                <button onclick="app.switchModule('adapt')" id="tab-adapt" class="nav-pill text-slate-500">
                    <i class="fa-solid fa-comments mr-2"></i> 結構性回饋
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-1 overflow-hidden relative z-10">
        <!-- Views injected here -->
    </main>

    <!-- Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="app.closeModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl p-8 w-full max-w-3xl transform transition-all scale-100 flex flex-col max-h-[90vh]" id="modal-content">
            <div class="flex flex-col items-center text-center mb-6 flex-shrink-0" id="modal-header">
                <div id="modal-icon" class="w-20 h-20 rounded-full bg-slate-100 flex items-center justify-center mb-4 text-4xl shadow-sm text-slate-500">
                    <i class="fa-solid fa-info"></i>
                </div>
                <h3 id="modal-title" class="text-3xl font-bold text-slate-800">提示</h3>
            </div>
            <div class="w-full mb-8 overflow-y-auto flex-1 pr-2 custom-scrollbar" id="modal-body-container">
                 <div id="modal-message" class="text-slate-600 text-xl leading-relaxed text-left">內容</div>
            </div>
            <div class="flex gap-4 w-full mt-auto pt-4 border-t border-slate-100" id="modal-actions">
                <button id="modal-btn-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 text-lg transition">取消</button>
                <button id="modal-btn-confirm" class="flex-1 py-3 rounded-xl bg-teal-600 text-white font-bold shadow-lg shadow-teal-600/20 hover:bg-teal-700 text-lg transition">確定</button>
            </div>
        </div>
    </div>

    <!-- 1. DASHBOARD TEMPLATE -->
    <template id="tpl-dashboard">
        <div class="w-full h-full overflow-y-auto px-8 py-10 fade-in">
            <div class="mb-10 text-center md:text-left">
                <h2 class="text-5xl font-black text-slate-800 tracking-tight mb-3 drop-shadow-sm" id="dashboard-title"></h2>
                <p class="text-slate-600 text-2xl font-medium" id="dashboard-desc"></p>
                <div class="mt-8 inline-flex flex-wrap gap-4 bg-white/70 backdrop-blur-md px-8 py-4 rounded-full shadow-lg border border-white text-lg">
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-300 ring-2 ring-slate-100"></span> 未開始</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-400 ring-2 ring-yellow-100"></span> 進行中</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500 ring-2 ring-green-100"></span> 已完成</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 pb-20" id="dashboard-grid"></div>
        </div>
    </template>

    <!-- 2. CCC GROUP VIEW -->
    <template id="tpl-ccc-group">
        <div class="flex flex-col lg:flex-row h-full w-full fade-in overflow-hidden">
            <div class="lg:hidden step-scroll-container flex-shrink-0" id="mobile-step-list"></div>
            <div class="hidden lg:flex flex-col w-60 bg-white/90 backdrop-blur-md border-r border-slate-200/60 overflow-hidden shadow-lg flex-shrink-0 h-full z-20">
                <div class="p-5 sidebar-header flex justify-between items-start shadow-md bg-teal-800 text-white">
                    <div class="flex items-center gap-3">
                         <button onclick="app.loadDashboard()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition" title="返回儀表板">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <div>
                            <div class="text-[10px] font-bold tracking-widest opacity-80 mb-1">GROUP</div>
                            <h2 class="text-xl font-black" id="group-title-sidebar">第 1 組</h2>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-2" id="desktop-step-list"></div>
            </div>
            <div class="flex-1 flex flex-col bg-white/50 backdrop-blur-sm h-full relative overflow-hidden">
                <div class="px-8 py-5 border-b border-slate-100 bg-white/80 backdrop-blur-md flex-shrink-0 flex justify-between items-center z-10 shadow-sm">
                    <div>
                        <div class="lg:hidden mb-3">
                             <button onclick="app.loadDashboard()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-teal-600 shadow-sm transition-all" title="返回儀表板">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-800 leading-tight" id="current-step-title"></h2>
                        <p class="text-base text-slate-500 font-medium mt-1" id="current-step-desc"></p>
                    </div>
                    <div class="hidden lg:block">
                        <button id="next-step-btn-desktop" class="bg-teal-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-teal-600/30 hover:bg-teal-700 hover:-translate-y-0.5 transition flex items-center gap-2 text-lg">下一步 <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-8 flex flex-col" id="step-content"></div>
                <div class="mobile-action-bar lg:hidden flex-shrink-0">
                     <button id="next-step-btn-mobile" class="w-full bg-teal-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-teal-600/20 active:scale-95 transition flex items-center justify-center gap-2 text-lg">下一步 <i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </template>

    <!-- 3. REMEDIATION GROUP VIEW -->
    <template id="tpl-remediation-group">
        <div class="w-full h-full flex flex-col fade-in overflow-hidden">
            <div class="bg-white/90 backdrop-blur-md px-8 py-5 border-b border-slate-200 flex justify-between items-center flex-shrink-0 shadow-sm z-10">
                <div class="flex items-center gap-4">
                    <button onclick="app.loadDashboard()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-teal-600 shadow-sm transition-all" title="返回儀表板">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="font-bold text-slate-800 text-2xl" id="rem-group-title">第 1 組計畫</h2>
                        <p class="text-sm text-slate-500 font-bold tracking-wide text-indigo-500">REMEDIATION PLANNING</p>
                    </div>
                </div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar" id="rem-tabs-container"></div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 lg:p-6 flex flex-col">
                <div class="mb-6 bg-white/80 backdrop-blur border border-indigo-100 rounded-2xl shadow-sm p-6 relative flex-shrink-0">
                    <div class="absolute top-0 left-0 w-2 h-full bg-indigo-500 rounded-l-2xl"></div>
                    <h3 class="font-bold text-slate-700 text-xl mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-info text-indigo-500"></i> CCC 參考資訊</h3>
                    <div id="rem-ccc-reference"></div>
                </div>

                <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg border border-white/50 flex-1 flex flex-col overflow-hidden min-h-[400px]">
                    <div class="p-5 border-b border-slate-200 bg-white/50 flex justify-between items-center flex-shrink-0">
                        <h4 class="font-bold text-slate-800 flex items-center gap-2 text-xl">
                            <i class="fa-solid fa-list-check text-blue-600"></i> 補強計畫表
                        </h4>
                        <button onclick="app.addRemediationRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-md transition flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> 新增項目
                        </button>
                    </div>
                    
                    <div class="hidden lg:block overflow-auto flex-1">
                        <table class="w-full rem-table min-w-[1200px] text-left">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="w-[20%] p-4 bg-slate-50 border-b-2 border-slate-200 text-slate-600 font-bold">缺失/問題</th>
                                    <th class="w-[15%] p-4 bg-slate-50 border-b-2 border-slate-200 text-slate-600 font-bold">核心能力</th>
                                    <th class="w-[20%] p-4 bg-slate-50 border-b-2 border-slate-200 text-slate-600 font-bold">行動計畫</th>
                                    <th class="w-[15%] p-4 bg-slate-50 border-b-2 border-slate-200 text-slate-600 font-bold">評量方法</th>
                                    <th class="w-[15%] p-4 bg-slate-50 border-b-2 border-slate-200 text-slate-600 font-bold">目標</th>
                                    <th class="w-[10%] p-4 bg-slate-50 border-b-2 border-slate-200 text-slate-600 font-bold">期限</th>
                                    <th class="w-[5%] p-4 bg-slate-50 border-b-2 border-slate-200"></th>
                                </tr>
                            </thead>
                            <tbody id="rem-table-body-desktop"></tbody>
                        </table>
                    </div>

                    <div class="lg:hidden p-4 space-y-4 overflow-y-auto flex-1" id="rem-list-mobile"></div>

                    <div id="rem-empty-state" class="text-center py-20 hidden bg-transparent flex-1 flex flex-col justify-center items-center">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-6 text-slate-300 text-4xl shadow-sm border border-slate-100">
                            <i class="fa-solid fa-clipboard-question"></i>
                        </div>
                        <p class="text-slate-500 font-bold text-lg">尚無計畫內容，請點擊右上角新增</p>
                    </div>
                </div>
            </div>

            <div class="bg-white/90 backdrop-blur border-t border-slate-200 p-6 flex justify-end gap-4 flex-shrink-0 z-20">
                <button onclick="app.completeRemediation()" class="w-full lg:w-auto bg-indigo-600 text-white px-10 py-4 rounded-xl font-bold shadow-lg shadow-indigo-600/30 hover:bg-indigo-700 hover:-translate-y-0.5 transition flex items-center justify-center gap-2 text-lg">
                    提交計畫 <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- 4. STRUCTURED FEEDBACK GROUP VIEW (Updated per PDF) -->
    <template id="tpl-adapt-group">
        <div class="w-full h-full flex flex-col fade-in overflow-hidden">
            <!-- Header Area -->
            <div class="bg-white/90 backdrop-blur-md px-8 py-5 border-b border-slate-200 flex justify-between items-center flex-shrink-0 shadow-sm z-10">
                <div class="flex items-center gap-4">
                    <button onclick="app.loadDashboard()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 hover:text-teal-600 shadow-sm transition-all" title="返回儀表板">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="font-bold text-slate-800 text-2xl" id="adapt-group-title">第 1 組 結構性回饋技巧</h2>
                        <p class="text-sm text-slate-500 font-bold tracking-wide text-orange-500">STRUCTURED FEEDBACK</p>
                    </div>
                </div>
                <!-- Mobile Only Tab Switcher -->
                <div class="lg:hidden flex gap-2 overflow-x-auto no-scrollbar" id="adapt-tabs-container"></div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 lg:p-8 bg-slate-50/50">
                <div class="max-w-7xl mx-auto h-full flex flex-col">
                    
                    <!-- Instruction Card -->
                    <div class="mb-6 bg-white p-6 rounded-2xl border border-orange-100 shadow-sm flex items-start gap-4">
                        <div class="w-12 h-12 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center flex-shrink-0 text-xl">
                            <i class="fa-solid fa-comments"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg mb-1">演練記錄說明</h3>
                            <p class="text-slate-500 text-sm leading-relaxed">
                                請根據演練過程，記錄兩位學員（王大明、李小美）在回饋對話中所運用的技巧，以及觀察到的限制與挑戰。
                            </p>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div id="adapt-content" class="flex-1">
                        <!-- Content will be injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="bg-white/90 backdrop-blur border-t border-slate-200 p-6 flex justify-end gap-4 flex-shrink-0 z-20">
                 <button onclick="app.completeAdapt()" class="w-full lg:w-auto bg-adapt hover-bg-adapt text-white px-10 py-4 rounded-xl font-bold shadow-lg shadow-[#ed7d31]/30 transition hover:-translate-y-0.5 flex items-center justify-center gap-2 text-lg">
                    提交回饋紀錄 <i class="fa-solid fa-paper-plane"></i>
                 </button>
            </div>
        </div>
    </template>

    <script>
        /* --- CONFIGURATION --- */
        const API_URL = "https://script.google.com/macros/s/AKfycbz-itROdnBGhhk0Ii7btFXFhV50B7846V0F5shjvm8Z4vcbh6r0UsRSieSpn0bW-CEztQ/exec"; 

        const CCC_STEPS = [
            { id: 1, title: "角色分配", duration: 5, desc: "確認委員會成員角色職責", label: "STEP 1" },
            { id: 2, title: "查閱學習歷程", duration: 10, desc: "檢視學員 PGY 學習檔案與規範標準", label: "STEP 2" },
            { id: 3, title: "主席摘要", duration: 5, desc: "主席報告學員表現重點", label: "STEP 3" },
            { id: 4, title: "品質面向討論", duration: 20, desc: "ARICH 品質面向深入討論", label: "STEP 4" },
            { id: 5, title: "信賴決策與輔導", duration: 20, desc: "進行信賴決策與輔導計畫", label: "STEP 5" },
            { id: 6, title: "會議紀錄", duration: 20, desc: "紀錄討論共識與重點", label: "紀錄專區" }, 
            { id: 7, title: "觀察員紀錄", duration: 0, desc: "觀察員填寫回饋表單", label: "觀察員專區" }
        ];

        const ROLES = [
            { name: "CCC主席", count: 1, icon: "fa-gavel", desc: "<div class='role-content'><strong>【角色身份】</strong>經驗豐富的 PGY 資深臨床教師...</div>" },
            { name: "會議記錄者", count: 1, icon: "fa-pen-to-square", desc: "<div class='role-content'><strong>【角色身份】</strong>護理部教學行政人員...</div>" },
            { name: "護理部教學負責人", count: 1, icon: "fa-clipboard-user", desc: "<div class='role-content'><strong>【角色身份】</strong>任職滿 10 年...</div>" },
            { name: "病房資深臨床教師", count: 1, icon: "fa-user-tie", desc: "<div class='role-content'><strong>【角色身份】</strong>20 年經驗，負責 PGY...</div>" },
            { name: "病房護理長", count: 1, icon: "fa-user-nurse", desc: "<div class='role-content'><strong>【角色身份】</strong>護理長 >10 年...</div>" },
            { name: "病房新任臨床教師", count: 1, icon: "fa-id-badge", desc: "<div class='role-content'><strong>【角色身份】</strong>新任 PGY 指導教師...</div>" },
            { name: "觀察員", count: "N", icon: "fa-eye", desc: "<div class='role-content'><strong>【主要任務】</strong>依「臨床能力委員會討論過程-觀察表」...</div>" }
        ];

        const ARICH_CATS = [
            { id: 'integrity', label: '誠信', icon: 'fa-scale-balanced', desc: '誠實與仁慈' },
            { id: 'reliability', label: '可靠性', icon: 'fa-shield-halved', desc: '盡責與穩定' },
            { id: 'humility', label: '謙遜', icon: 'fa-hand-holding-hand', desc: '能辨識自身限制並於需要時主動求助' },
            { id: 'agency', label: '行動力', icon: 'fa-person-running', desc: '積極主動' }
        ];

        const OBSERVER_ITEMS = {
            "會議程序": ["主席有說明會議的目的與重點", "適當引導發言順序為「由幼至長」", "討論的過程展現意見的「多樣性」", "意見衝突時的處理機制"],
            "決策過程": ["決策考慮學員的專業素養 (ARICH)", "決策主要依據具體之「客觀事證」", "不受限於「階級」與「和諧」之框架", "達到「共享心智模式」之師培目的"]
        };

        class App {
            constructor() {
                this.currentModule = 'ccc';
                this.isSyncing = false;
                this.groups = Array.from({ length: 8 }, (_, i) => ({
                    id: i + 1,
                    cccStep: 0, cccCompleted: false, remCompleted: false, adaptCompleted: false,
                    students: {
                        daming: { 
                            name: "王大明", result: null, reason: "", plan: "", summary: "", qualityNote: "", meetingNote: "", 
                            remediationPlan: [], 
                            feedbackTechniques: "", challengesLimits: "", // UPDATED for new ADAPT
                            trustLevel: null 
                        },
                        xiaomei: { 
                            name: "李小美", result: null, reason: "", plan: "", summary: "", qualityNote: "", meetingNote: "", 
                            remediationPlan: [], 
                            feedbackTechniques: "", challengesLimits: "", // UPDATED for new ADAPT
                            trustLevel: null 
                        }
                    },
                    activeStudentTab: 'daming', observerData: {}
                }));
                this.activeGroupId = null;
                this.secondsElapsed = 0;
                
                this.initTimer();
                this.fetchDataFromGoogleSheet(false);
                setInterval(() => { this.fetchDataFromGoogleSheet(true); }, 30000);
                this.switchModule('ccc');
            }

            initTimer() {
                setInterval(() => {
                    this.secondsElapsed++;
                    const min = Math.floor(this.secondsElapsed / 60).toString().padStart(2, '0');
                    const sec = (this.secondsElapsed % 60).toString().padStart(2, '0');
                    document.getElementById('global-timer').innerText = `${min}:${sec}`;
                }, 1000);
            }

            switchModule(mod) {
                this.currentModule = mod;
                if (mod !== 'ccc') this.activeGroupId = null;
                document.body.classList.remove('theme-ccc', 'theme-remediation', 'theme-adapt');
                document.body.classList.add(`theme-${mod}`);
                ['ccc', 'remediation', 'adapt'].forEach(m => {
                    const el = document.getElementById(`tab-${m}`);
                    if(m === mod) {
                        el.classList.add('active');
                        if(mod === 'ccc') { el.classList.add('text-teal-800', 'border-teal-600'); }
                        if(mod === 'remediation') { el.classList.add('text-indigo-800', 'border-indigo-600'); }
                        if(mod === 'adapt') { el.classList.add('text-[#d06015]', 'border-[#d06015]'); }
                    } else {
                        el.classList.remove('active', 'text-teal-800', 'border-teal-600', 'text-indigo-800', 'border-indigo-600', 'text-[#d06015]', 'border-[#d06015]');
                        el.classList.add('text-slate-500');
                    }
                });
                
                const icon = document.getElementById('app-icon');
                if(mod === 'ccc') icon.className = `w-16 h-16 rounded-2xl bg-teal-600 text-white flex items-center justify-center shadow-lg transition-colors duration-500 transform hover:scale-105`;
                if(mod === 'remediation') icon.className = `w-16 h-16 rounded-2xl bg-indigo-600 text-white flex items-center justify-center shadow-lg transition-colors duration-500 transform hover:scale-105`;
                if(mod === 'adapt') icon.className = `w-16 h-16 rounded-2xl bg-adapt text-white flex items-center justify-center shadow-lg transition-colors duration-500 transform hover:scale-105`;

                if (mod === 'ccc') {
                    const targetGroup = this.activeGroupId || 1;
                    this.loadGroup(targetGroup);
                } else {
                    this.loadDashboard();
                }
            }

            loadDashboard() {
                this.activeGroupId = null;
                const tpl = document.getElementById('tpl-dashboard');
                const container = document.getElementById('main-container');
                container.innerHTML = '';
                container.appendChild(tpl.content.cloneNode(true));
                container.scrollTop = 0;

                const titleEl = document.getElementById('dashboard-title');
                const descEl = document.getElementById('dashboard-desc');
                const titleClass = document.getElementById('dashboard-title').classList;
                titleClass.remove('text-teal-900', 'text-indigo-900', 'text-adapt');

                if(this.currentModule === 'ccc') {
                    titleEl.innerText = "CCC 臨床能力委員會演練";
                    descEl.innerText = "即時監控 8 個小組的討論進度與決策結果";
                    titleClass.add('text-teal-900');
                } else if(this.currentModule === 'remediation') {
                    titleEl.innerText = "補強計畫設計演練";
                    descEl.innerText = "針對學員缺失設計具體行動方案";
                    titleClass.add('text-indigo-900');
                } else {
                    titleEl.innerText = "結構性回饋模組";
                    descEl.innerText = "記錄回饋技巧與觀察重點";
                    titleClass.add('text-adapt');
                }

                const grid = document.getElementById('dashboard-grid');
                this.groups.forEach(g => grid.appendChild(this.createCard(g)));
            }

            createCard(g) {
                const div = document.createElement('div');
                div.className = "dashboard-card cursor-pointer group";
                div.onclick = () => this.loadGroup(g.id);
                
                let progress = 0, statusColor = "bg-slate-300", statusText = "未開始", barColor = "";

                if(this.currentModule === 'ccc') {
                    barColor = "bg-teal-500";
                    if (g.cccCompleted) { progress = 100; statusColor = "bg-green-500"; statusText = "已完成"; } 
                    else if (g.cccStep > 0) { progress = Math.min(90, (g.cccStep / 6) * 100); statusColor = "bg-yellow-400"; statusText = "進行中"; }
                } else if(this.currentModule === 'remediation') {
                    barColor = "bg-indigo-500";
                    if (g.remCompleted) { progress = 100; statusColor = "bg-green-500"; statusText = "完成"; }
                    else if (g.students.daming.remediationPlan.length > 0) { progress = 50; statusColor = "bg-yellow-400"; statusText = "進行中"; }
                } else {
                    barColor = "bg-adapt";
                    if (g.adaptCompleted) { progress = 100; statusColor = "bg-green-500"; statusText = "完成"; }
                    else if (g.students.daming.feedbackTechniques || g.students.xiaomei.feedbackTechniques) { progress = 50; statusColor = "bg-yellow-400"; statusText = "進行中"; }
                }

                div.innerHTML = `
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="font-black text-3xl text-slate-800 tracking-tight">第 ${g.id} 組</h3>
                            <div class="flex items-center gap-2 text-sm font-bold text-slate-500"><span class="w-3 h-3 rounded-full ${statusColor} ring-2 ring-white"></span> ${statusText}</div>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-4 mb-8 overflow-hidden border border-slate-200"><div class="h-full ${barColor} transition-all duration-1000 ease-out" style="width: ${progress}%"></div></div>
                        <div class="text-lg font-bold text-slate-400 flex justify-between items-center group-hover:text-slate-600 transition-colors">
                            <span>${this.currentModule==='ccc'?(g.cccCompleted?'演練結束':`Step ${g.cccStep}`):(this.currentModule==='remediation'?'計畫填寫':'回饋紀錄')}</span>
                            <div class="w-10 h-10 rounded-full bg-slate-50 group-hover:bg-slate-100 flex items-center justify-center transition-colors"><i class="fa-solid fa-arrow-right"></i></div>
                        </div>
                    </div>`;
                return div;
            }

            loadGroup(id) {
                this.activeGroupId = id;
                const container = document.getElementById('main-container');
                container.innerHTML = '';
                container.scrollTop = 0;
                if (this.currentModule === 'ccc') {
                    container.appendChild(document.getElementById('tpl-ccc-group').content.cloneNode(true));
                    this.renderCCC();
                } else if (this.currentModule === 'remediation') {
                    container.appendChild(document.getElementById('tpl-remediation-group').content.cloneNode(true));
                    this.renderRemediation();
                } else {
                    container.appendChild(document.getElementById('tpl-adapt-group').content.cloneNode(true));
                    this.renderAdapt();
                }
            }

            // === CCC Logic ===
            renderCCC() {
                const g = this.groups[this.activeGroupId - 1];
                document.getElementById('group-title-sidebar').innerText = `第 ${g.id} 組`;
                
                const renderSteps = (containerId, isMobile) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    CCC_STEPS.forEach((s, i) => {
                        const isActive = i === g.cccStep;
                        const el = document.createElement('div');
                        if (isMobile) { el.className = `step-pill ${isActive ? 'active' : ''}`; el.innerText = `${i+1}. ${s.title}`; } 
                        else { el.className = `sidebar-item ${isActive ? 'active' : ''}`; el.innerHTML = `<div class="label">${s.label}</div><div class="title">${s.title}</div>`; }
                        el.onclick = () => { g.cccStep = i; this.renderCCC(); };
                        container.appendChild(el);
                    });
                };
                renderSteps('mobile-step-list', true);
                renderSteps('desktop-step-list', false);

                const step = CCC_STEPS[g.cccStep];
                document.getElementById('current-step-title').innerText = step.title;
                document.getElementById('current-step-desc').innerText = step.desc;
                
                const contentContainer = document.getElementById('step-content');
                if (g.cccStep === 1) contentContainer.classList.add('p-0'); else contentContainer.classList.add('p-8');
                contentContainer.innerHTML = this.getCCCContentHTML(g.cccStep + 1);

                const btnText = (g.cccStep === 6) ? '返回儀表板' : (g.cccStep === 5) ? '完成演練' : '下一步 <i class="fa-solid fa-arrow-right ml-2"></i>';
                const btnAction = (g.cccStep === 6) ? () => this.loadDashboard() : (g.cccStep === 5) ? () => this.completeCCCGroupSimulation() : () => { g.cccStep++; this.renderCCC(); this.sendDataToGoogleSheet(g, 'ccc'); };
                
                const btnDesktop = document.getElementById('next-step-btn-desktop');
                const btnMobile = document.getElementById('next-step-btn-mobile');
                if (btnDesktop) { btnDesktop.innerHTML = btnText; btnDesktop.onclick = btnAction; }
                if (btnMobile) { btnMobile.innerHTML = btnText; btnMobile.onclick = btnAction; }
            }

            getCCCContentHTML(stepId) {
                const g = this.groups[this.activeGroupId - 1];
                const activeKey = g.activeStudentTab;
                const s = g.students[activeKey];
                
                const getTabs = () => `<div class="flex gap-3 border-b border-slate-200/50 mb-0 px-0 pt-2"><button onclick="app.switchStudentTab('daming')" class="px-6 py-2 rounded-t-xl font-bold transition-all text-base flex-1 md:flex-none flex items-center justify-center border-b-0 ${activeKey==='daming'?'bg-blue-600 text-white shadow-lg transform -translate-y-1':'bg-slate-100/80 text-slate-500 hover:bg-slate-200'}">王大明</button><button onclick="app.switchStudentTab('xiaomei')" class="px-6 py-2 rounded-t-xl font-bold transition-all text-base flex-1 md:flex-none flex items-center justify-center border-b-0 ${activeKey==='xiaomei'?'bg-pink-600 text-white shadow-lg transform -translate-y-1':'bg-slate-100/80 text-slate-500 hover:bg-slate-200'}">李小美</button></div>`;

                if (stepId === 1) return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${ROLES.map(r => `<div class="glass-panel p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl transition flex flex-col h-full"><div class="flex items-center gap-4 mb-4"><div class="w-12 h-12 rounded-xl bg-teal-50 text-teal-600 flex items-center justify-center shadow-inner"><i class="fa-solid ${r.icon} text-xl"></i></div><div><h4 class="font-bold text-slate-800 text-lg">${r.name}</h4><span class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-bold">人數: ${r.count}</span></div></div><div class="text-sm text-slate-600 leading-relaxed text-justify">${r.desc}</div></div>`).join('')}</div>`;
                
                if (stepId === 2) return `
                    <div class="flex flex-col h-full w-full overflow-hidden">
                        <div class="flex-1 bg-white/90 backdrop-blur-sm shadow-md flex flex-col overflow-hidden relative">
                            <div class="px-6 py-3 border-b border-slate-200 bg-white flex justify-between items-center flex-shrink-0 z-10 gap-4 shadow-sm">
                                <div class="flex items-center gap-4 overflow-hidden"><div class="w-10 h-10 rounded-lg bg-teal-600 text-white flex items-center justify-center shadow-md flex-shrink-0"><i class="fa-solid fa-book-open text-lg"></i></div><div><h3 class="text-base font-black text-slate-800 leading-tight">查閱學習歷程檔案</h3><div class="flex items-center gap-2 text-xs text-slate-500 font-bold mt-0.5"><span class="px-2 py-0.5 rounded bg-teal-100 text-teal-800 border border-teal-200">EPA 標準</span><span>主題：住院病患的照護與衛教</span></div></div></div>
                                <div class="flex gap-2 flex-shrink-0"><button class="px-3 py-2 rounded-lg border border-blue-200 font-bold text-blue-700 bg-blue-50 hover:bg-blue-100 transition shadow-sm text-sm" onclick="window.open('https://drive.google.com/file/d/1mNICzHyTto5aXcY2NJEOGlswkRq5GbXD/view?usp=drive_link','_blank')">王大明 檔案</button><button class="px-3 py-2 rounded-lg border border-pink-200 font-bold text-pink-700 bg-pink-50 hover:bg-pink-100 transition shadow-sm text-sm" onclick="window.open('https://drive.google.com/file/d/19TJ1wgrjWM-EO4jQWImYQrJS7Vzzru-7/view?usp=drive_link','_blank')">李小美 檔案</button></div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-5 bg-slate-50/50 custom-scrollbar"><div class="max-w-7xl mx-auto space-y-4"><div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><h5 class="text-teal-700 font-black text-sm mb-3">任務描述</h5><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs"><div class="bg-slate-50 p-3 rounded"><strong>疾病知識</strong><p>熟悉常見內外科病理...</p></div><div class="bg-slate-50 p-3 rounded"><strong>臨床照護</strong><p>整體評估、擬定計畫...</p></div><div class="bg-slate-50 p-3 rounded"><strong>溝通衛教</strong><p>有效衛教與回饋...</p></div></div></div><div class="bg-gradient-to-br from-teal-50 to-white p-4 rounded-xl border-2 border-teal-100 shadow-sm"><h5 class="text-teal-800 font-black text-sm mb-2">授權標準 (Level 3c)</h5><ul class="text-xs space-y-1"><li><i class="fa-solid fa-check text-teal-500"></i> 完成病房核心訓練課程</li><li><i class="fa-solid fa-check text-teal-500"></i> 獨立照護 ≥5名病人</li></ul></div></div></div>
                        </div>
                    </div>`;

                if (stepId === 3) return `<div class="glass-panel flex flex-col h-full rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div class="px-6 border-b border-slate-200 bg-white/50">${getTabs()}</div><div class="flex-1 p-0 relative"><textarea class="w-full h-full p-8 text-xl focus:ring-0 border-0 bg-transparent leading-relaxed resize-none" placeholder="請在此輸入學員的主席摘要..." oninput="app.updateInput('${activeKey}','summary',this.value)">${s.summary}</textarea></div></div>`;
                
                if (stepId === 4) return `<div class="flex flex-col gap-6"><div class="grid grid-cols-4 gap-6 flex-shrink-0">${ARICH_CATS.map(c=>`<div class="glass-panel p-4 rounded-2xl border border-slate-200 text-center shadow-sm"><div class="w-12 h-12 mx-auto rounded-full bg-teal-50 text-teal-600 flex items-center justify-center text-xl mb-3"><i class="fa-solid ${c.icon}"></i></div><div class="font-bold text-slate-800">${c.label}</div></div>`).join('')}</div><div class="glass-panel rounded-2xl border border-slate-200 shadow-sm"><div class="px-6 border-b border-slate-200 bg-white/50">${getTabs()}</div><div class="p-0 relative"><textarea class="w-full p-8 text-xl focus:ring-0 border-0 h-96 resize-none" placeholder="請記錄品質面向討論內容..." oninput="app.updateInput('${activeKey}', 'qualityNote', this.value)">${s.qualityNote}</textarea></div></div></div>`;

                if (stepId === 5) {
                     const levels = [{l:1,t:"Level 1 只看不做"},{l:2,t:"Level 2a 直接監督，逐步協助"},{l:3,t:"Level 2b 直接監督，必要時協助"},{l:4,t:"Level 3a 間接監督，事後逐項確認"},{l:5,t:"Level 3b 間接監督，事後重點確認"},{l:6,t:"Level 3c 間接監督 (通過門檻)"},{l:7,t:"Level 4 獨立執行"}];
                     let statusHtml = s.trustLevel ? (s.trustLevel>=6 ? '<span class="ml-4 px-4 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-bold">PASS</span>' : '<span class="ml-4 px-4 py-1.5 bg-red-100 text-red-700 rounded-full text-sm font-bold">FAIL</span>') : '';
                     return `<div class="glass-panel rounded-2xl border border-slate-200 shadow-sm"><div class="px-6 border-b border-slate-200 bg-white/50">${getTabs()}</div><div class="p-6 bg-slate-50/50 border-b border-slate-100"><h4 class="font-bold text-slate-700 mb-4">信賴程度 ${statusHtml}</h4><div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-7 gap-3">${levels.map(l=>`<button onclick="app.setTrustLevel(${l.l})" class="text-left px-3 py-3 rounded-xl border text-xs font-bold transition-all ${s.trustLevel===l.l?'bg-teal-600 text-white border-teal-600':'bg-white border-slate-200 text-slate-600 hover:bg-white hover:border-teal-300'}">${l.t}</button>`).join('')}</div></div><div class="grid grid-cols-2 divide-x divide-slate-100"><textarea class="p-6 text-lg border-0 resize-none h-80 bg-transparent" placeholder="決策原因..." oninput="app.updateInput('${activeKey}','reason',this.value)">${s.reason}</textarea><textarea class="p-6 text-lg border-0 resize-none h-80 bg-transparent" placeholder="輔導方案..." oninput="app.updateInput('${activeKey}','plan',this.value)">${s.plan}</textarea></div></div>`;
                }

                if (stepId === 6) return `<div class="glass-panel flex flex-col h-full rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div class="px-6 border-b border-slate-200 bg-white/50">${getTabs()}</div><div class="flex-1 p-0 relative"><textarea class="w-full h-full p-8 text-xl focus:ring-0 border-0 bg-transparent leading-relaxed resize-none" placeholder="請輸入會議紀錄與共識..." oninput="app.updateInput('${activeKey}','meetingNote',this.value)">${s.meetingNote}</textarea></div></div>`;
                
                if (stepId === 7) return `<div class="glass-panel rounded-2xl border border-slate-200 shadow-sm"><div class="px-6 border-b border-slate-200 bg-white/50">${getTabs()}</div><div class="grid grid-cols-2 divide-x divide-slate-200">${Object.entries(OBSERVER_ITEMS).map(([cat,items])=>`<div class="flex flex-col"><div class="p-5 bg-slate-50/50 border-b border-slate-100"><h5 class="font-bold text-slate-800">${cat}</h5><ul class="list-disc pl-5 text-xs text-slate-500">${items.map(i=>`<li>${i}</li>`).join('')}</ul></div><textarea class="w-full p-5 text-sm h-64 border-0 resize-none bg-transparent" placeholder="實際觀察..." oninput="app.updateObs('${activeKey}','${cat}-actual',this.value)">${g.observerData[`${activeKey}-${cat}-actual`]||''}</textarea></div>`).join('')}</div></div>`;
            }

            // === Remediation Logic ===
            renderRemediation() {
                const g = this.groups[this.activeGroupId - 1];

                // [FIX] 動態更新補強計畫的組別標題
                const titleEl = document.getElementById('rem-group-title');
                if (titleEl) titleEl.innerText = `第 ${g.id} 組計畫`;

                const key = g.activeStudentTab;
                const container = document.getElementById('rem-tabs-container');
                if(container) container.innerHTML = `<button onclick="app.switchStudentTab('daming')" class="px-4 py-2 rounded-lg text-sm font-bold ${key==='daming'?'bg-blue-600 text-white':'bg-slate-100 text-slate-500'}">王大明</button><button onclick="app.switchStudentTab('xiaomei')" class="px-4 py-2 rounded-lg text-sm font-bold ${key==='xiaomei'?'bg-pink-600 text-white':'bg-slate-100 text-slate-500'}">李小美</button>`;
                
                const s = g.students[key];
                const res = s.result === true ? 'PASS' : s.result === false ? 'FAIL' : '未定';
                document.getElementById('rem-ccc-reference').innerHTML = `<div class="text-sm">CCC 決策: <span class="font-bold">${res}</span><br>原因: ${s.reason||'-'}<br>輔導: ${s.plan||'-'}</div>`;

                const tbody = document.getElementById('rem-table-body-desktop');
                if(tbody) {
                    tbody.innerHTML = '';
                    s.remediationPlan.forEach((item, idx) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td><textarea class="w-full bg-white p-2 border rounded" oninput="app.updateRemRow(${idx},'deficit',this.value)">${item.deficit}</textarea></td><td><textarea class="w-full bg-white p-2 border rounded" oninput="app.updateRemRow(${idx},'competency',this.value)">${item.competency}</textarea></td><td><textarea class="w-full bg-white p-2 border rounded" oninput="app.updateRemRow(${idx},'action',this.value)">${item.action}</textarea></td><td><textarea class="w-full bg-white p-2 border rounded" oninput="app.updateRemRow(${idx},'assessment',this.value)">${item.assessment}</textarea></td><td><textarea class="w-full bg-white p-2 border rounded" oninput="app.updateRemRow(${idx},'goal',this.value)">${item.goal}</textarea></td><td><textarea class="w-full bg-white p-2 border rounded" oninput="app.updateRemRow(${idx},'deadline',this.value)">${item.deadline}</textarea></td><td class="text-center"><button onclick="app.deleteRemRow(${idx})" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td>`;
                        tbody.appendChild(tr);
                    });
                }
                const mobileList = document.getElementById('rem-list-mobile');
                if(mobileList) {
                    mobileList.innerHTML = '';
                    s.remediationPlan.forEach((item, idx) => {
                        mobileList.innerHTML += `<div class="bg-white p-4 rounded shadow mb-2"><div class="flex justify-between font-bold mb-2"><span>項目 ${idx+1}</span><button onclick="app.deleteRemRow(${idx})" class="text-red-500">刪除</button></div><textarea class="w-full border p-2 mb-2" placeholder="缺失" oninput="app.updateRemRow(${idx},'deficit',this.value)">${item.deficit}</textarea><textarea class="w-full border p-2" placeholder="行動計畫" oninput="app.updateRemRow(${idx},'action',this.value)">${item.action}</textarea></div>`;
                    });
                }
                const empty = document.getElementById('rem-empty-state');
                if(empty) empty.classList.toggle('hidden', s.remediationPlan.length > 0);
            }

            // === UPDATED ADAPT Logic (PDF Style) ===
            renderAdapt() {
                const g = this.groups[this.activeGroupId - 1];
                const key = g.activeStudentTab;
                
                // 1. Mobile Tabs
                const damingBtn = `<button onclick="app.switchStudentTab('daming')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${key==='daming' ? 'bg-blue-600 text-white shadow' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">王大明</button>`;
                const xiaomeiBtn = `<button onclick="app.switchStudentTab('xiaomei')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${key==='xiaomei' ? 'bg-pink-600 text-white shadow' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">李小美</button>`;
                
                const adaptTabsContainer = document.getElementById('adapt-tabs-container');
                if (adaptTabsContainer) adaptTabsContainer.innerHTML = damingBtn + xiaomeiBtn;
                
                const adaptGroupTitle = document.getElementById('adapt-group-title');
                if (adaptGroupTitle) adaptGroupTitle.innerText = `第 ${g.id} 組 結構性回饋技巧`;

                const content = document.getElementById('adapt-content');
                
                const sDaming = g.students.daming;
                const sXiaomei = g.students.xiaomei;

                const renderTextarea = (studentKey, field, value, colorClass) => `
                    <div class="h-full flex flex-col">
                        <textarea class="flex-1 w-full p-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-${colorClass}-500/20 focus:border-${colorClass}-500 text-base resize-none bg-white transition-all leading-relaxed custom-scrollbar min-h-[200px]" 
                        placeholder="請輸入內容..." 
                        oninput="app.updateAdaptNew('${studentKey}', '${field}', this.value)">${value || ''}</textarea>
                    </div>
                `;

                // Desktop View (Split Grid)
                const desktopView = `
                    <div class="hidden lg:grid grid-cols-2 gap-6 h-full pb-10">
                        <div class="bg-blue-50/80 p-4 rounded-t-2xl border-b-4 border-blue-500 text-center font-black text-blue-800 text-xl shadow-sm"><i class="fa-solid fa-user-nurse mr-2"></i> 王大明</div>
                        <div class="bg-pink-50/80 p-4 rounded-t-2xl border-b-4 border-pink-500 text-center font-black text-pink-800 text-xl shadow-sm"><i class="fa-solid fa-user-nurse mr-2"></i> 李小美</div>

                        <div class="col-span-2 grid grid-cols-2 gap-6 bg-white/60 p-6 rounded-b-2xl rounded-t-lg border border-slate-200 shadow-sm mb-4">
                            <div class="col-span-2 text-center mb-2"><span class="bg-slate-800 text-white px-6 py-1.5 rounded-full text-sm font-bold tracking-wider">運用到的回饋技巧</span></div>
                            ${renderTextarea('daming', 'feedbackTechniques', sDaming.feedbackTechniques, 'blue')}
                            ${renderTextarea('xiaomei', 'feedbackTechniques', sXiaomei.feedbackTechniques, 'pink')}
                        </div>

                        <div class="col-span-2 grid grid-cols-2 gap-6 bg-white/60 p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="col-span-2 text-center mb-2"><span class="bg-orange-600 text-white px-6 py-1.5 rounded-full text-sm font-bold tracking-wider">遇到的限制與挑戰</span></div>
                            ${renderTextarea('daming', 'challengesLimits', sDaming.challengesLimits, 'blue')}
                            ${renderTextarea('xiaomei', 'challengesLimits', sXiaomei.challengesLimits, 'pink')}
                        </div>
                    </div>
                `;

                // Mobile View (Stacked)
                const currentS = g.students[key];
                const color = key === 'daming' ? 'blue' : 'pink';
                const mobileView = `
                    <div class="lg:hidden flex flex-col gap-6 pb-20">
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                            <label class="block text-slate-700 font-bold mb-3 flex items-center gap-2"><span class="w-8 h-8 rounded-lg bg-${color}-100 text-${color}-600 flex items-center justify-center"><i class="fa-solid fa-wand-magic-sparkles"></i></span>運用到的回饋技巧</label>
                            ${renderTextarea(key, 'feedbackTechniques', currentS.feedbackTechniques, color)}
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                             <label class="block text-slate-700 font-bold mb-3 flex items-center gap-2"><span class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fa-solid fa-mountain"></i></span>遇到的限制與挑戰</label>
                            ${renderTextarea(key, 'challengesLimits', currentS.challengesLimits, color)}
                        </div>
                    </div>
                `;

                content.innerHTML = desktopView + mobileView;
            }

            // --- Helper Functions ---
            switchStudentTab(student) { 
                this.groups[this.activeGroupId - 1].activeStudentTab = student;
                if(this.currentModule === 'ccc') this.renderCCC();
                else if(this.currentModule === 'remediation') this.renderRemediation();
                else if(this.currentModule === 'adapt') this.renderAdapt();
            }
            updateInput(student, field, value) { this.groups[this.activeGroupId - 1].students[student][field] = value; }
            updateObs(student, field, value) { this.groups[this.activeGroupId - 1].observerData[`${student}-${field}`] = value; }
            setTrustLevel(level) { 
                const s = this.groups[this.activeGroupId - 1].students[this.groups[this.activeGroupId - 1].activeStudentTab];
                s.trustLevel = level; s.result = (level >= 6); this.renderCCC();
            }
            addRemediationRow() { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan.push({deficit:'',competency:'',action:'',assessment:'',goal:'',deadline:''}); this.renderRemediation(); }
            updateRemRow(idx, field, val) { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan[idx][field] = val; }
            deleteRemRow(idx) { if(confirm('刪除此項目?')) { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan.splice(idx,1); this.renderRemediation(); } }
            updateAdaptNew(studentKey, field, value) { const g = this.groups[this.activeGroupId - 1]; if (g && g.students[studentKey]) g.students[studentKey][field] = value; }
            
            showModal({ title, message, onConfirm }) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-message').innerHTML = message;
                document.getElementById('modal-btn-confirm').onclick = () => { this.closeModal(); if(onConfirm) onConfirm(); };
                document.getElementById('custom-modal').classList.remove('hidden');
            }
            closeModal() { document.getElementById('custom-modal').classList.add('hidden'); }
            
            completeCCCGroupSimulation() {
                const g = this.groups[this.activeGroupId - 1];
                if (g.students.daming.result !== null && g.students.xiaomei.result !== null) {
                    this.showModal({title:"確認結束", message:"確定要結束並送出嗎？", onConfirm:()=>{ g.cccCompleted=true; g.cccStep=6; this.sendDataToGoogleSheet(g,'ccc'); this.loadDashboard(); }});
                } else alert("請先完成兩位學員的信賴決策");
            }
            completeRemediation() { this.showModal({title:"提交計畫", message:"確定提交補強計畫嗎？", onConfirm:()=>{ this.groups[this.activeGroupId-1].remCompleted=true; this.sendDataToGoogleSheet(this.groups[this.activeGroupId-1],'remediation'); this.loadDashboard(); }}); }
            completeAdapt() { this.showModal({title:"提交回饋", message:"確定提交回饋紀錄嗎？", onConfirm:()=>{ this.groups[this.activeGroupId-1].adaptCompleted=true; this.sendDataToGoogleSheet(this.groups[this.activeGroupId-1],'adapt'); this.loadDashboard(); }}); }

            // --- API Logic ---
            fetchDataFromGoogleSheet(isBg) {
                if(this.isSyncing) return;
                this.isSyncing = true;
                if(!isBg) document.getElementById('loading-overlay').style.display='flex';
                fetch(API_URL).then(r=>r.json()).then(resp => {
                    if(resp.result==='success') this.processServerData(resp.data);
                }).finally(()=>{
                    this.isSyncing=false;
                    if(!isBg) document.getElementById('loading-overlay').style.display='none';
                });
            }

            processServerData(data) {
                if (!this.groups) return;
                const canUpdate = (gid) => (this.activeGroupId === null || this.activeGroupId !== gid);

                if (data.CCC_Master_Log) {
                    data.CCC_Master_Log.forEach(row => {
                        const gid = parseInt(row[1]);
                        if (!canUpdate(gid)) return;
                        const sKey = row[2]==="王大明"?"daming":row[2]==="李小美"?"xiaomei":null;
                        if(sKey) {
                            const s = this.groups[gid-1].students[sKey];
                            s.summary = row[3]; s.qualityNote = row[4]; s.result = row[5]==="PASS"; s.reason = row[6]; s.plan = row[7]; s.meetingNote = row[8];
                            if(row[10]==="Completed") { this.groups[gid-1].cccCompleted=true; this.groups[gid-1].cccStep=6; }
                            else if(row[10] && row[10].startsWith("Step")) this.groups[gid-1].cccStep = parseInt(row[10].split(" ")[1]);
                        }
                    });
                }
                
                // UPDATED Process Logic for new ADAPT format
                if (data.ADAPT_Feedbeck_Log) { 
                    data.ADAPT_Feedbeck_Log.forEach(row => {
                        const gid = parseInt(row[1]);
                        if (!canUpdate(gid)) return;
                        const sKey = row[2]==="王大明"?"daming":row[2]==="李小美"?"xiaomei":null;
                        if(sKey) {
                            const s = this.groups[gid-1].students[sKey];
                            s.feedbackTechniques = row[3]; // Col D
                            s.challengesLimits = row[4];   // Col E
                            if (s.feedbackTechniques || s.challengesLimits) this.groups[gid-1].adaptCompleted = true;
                        }
                    });
                }
                if(this.activeGroupId === null) this.loadDashboard();
            }

            sendDataToGoogleSheet(group, type) {
                let sheetName = "", rows = [];
                const ts = new Date().toISOString();
                if(type === 'ccc') {
                    sheetName = "CCC_Master_Log";
                    ['daming','xiaomei'].forEach(k => {
                        const s = group.students[k];
                        rows.push([ts, group.id, s.name, s.summary, s.qualityNote, s.result===true?"PASS":s.result===false?"FAIL":"", s.reason, s.plan, s.meetingNote, JSON.stringify(group.observerData), group.cccCompleted?"Completed":`Step ${group.cccStep}`]);
                    });
                } else if(type === 'remediation') {
                    sheetName = "Remediation_Details";
                    ['daming','xiaomei'].forEach(k => {
                        group.students[k].remediationPlan.forEach(i => rows.push([ts, group.id, group.students[k].name, i.deficit, i.competency, i.action, i.assessment, i.goal, i.deadline]));
                    });
                } else if(type === 'adapt') {
                    // UPDATED Send Logic
                    sheetName = "ADAPT_Feedbeck_Log";
                    ['daming','xiaomei'].forEach(k => {
                        const s = group.students[k];
                        rows.push([ts, group.id, s.name, s.feedbackTechniques, s.challengesLimits]);
                    });
                }
                fetch(API_URL, {method:'POST', body:JSON.stringify({sheet:sheetName, data:rows})});
            }
        }
        const app = new App();
    </script>
</body>
</html>
