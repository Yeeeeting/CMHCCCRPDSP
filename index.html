<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CCC實務工作坊演練平台 V4.26 (觀察員介面簡化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --primary-teal: #0d9488;
            --primary-indigo: #4f46e5;
            --bg-slate: #f1f5f9;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-slate); 
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
            font-size: 20px; 
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; 
        }

        .dashboard-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-card:active { transform: scale(0.98); }

        @media (min-width: 768px) {
            .dashboard-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
                border-color: rgba(148, 163, 184, 0.5);
            }
        }

        .step-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 1rem; 
            padding: 1rem;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .step-scroll-container::-webkit-scrollbar { display: none; }

        .step-pill {
            flex: 0 0 auto;
            padding: 0.8rem 1.5rem;
            border-radius: 9999px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #64748b;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .step-pill.active {
            background: #0f766e;
            color: white;
            border-color: #0f766e;
            box-shadow: 0 2px 4px rgba(15, 118, 110, 0.2);
        }

        .sidebar-header {
            background-color: #115e59; 
            color: white;
        }
        
        .sidebar-item {
            padding: 1.25rem 1.5rem;
            border-left: 5px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background-color: #f8fafc;
        }
        
        .sidebar-item.active {
            background-color: #f0fdfa;
            border-left-color: #0d9488;
        }
        
        .sidebar-item .label {
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 0.35rem;
        }
        
        .sidebar-item.active .label {
            color: #2dd4bf;
        }

        .sidebar-item .title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #334155;
        }
        
        .sidebar-item.active .title {
            color: #0f766e;
        }

        textarea, input[type="text"] {
            font-size: 20px !important; 
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            padding: 14px 18px; 
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            line-height: 1.6;
        }
        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary-indigo);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .mobile-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px 24px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            z-index: 40;
            border-top: 1px solid #f1f5f9;
            display: flex;
            gap: 16px;
        }
        
        @media (min-width: 1024px) {
            .mobile-action-bar {
                position: static;
                box-shadow: none;
                border-top: none;
                padding: 0;
                background: transparent;
            }
        }

        .nav-pill {
            position: relative;
            padding: 1.2rem 2.5rem; 
            font-weight: 700;
            font-size: 1.25rem; 
            color: #64748b;
            transition: color 0.3s;
            cursor: pointer;
        }
        .nav-pill.active { color: #0f172a; }
        .nav-pill.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 5px; 
            background: currentColor;
            border-radius: 3px 3px 0 0;
        }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .rem-table th {
            background-color: #f8fafc;
            color: #475569;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1rem; 
            padding: 1.25rem;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        .rem-table td {
            padding: 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }
        .rem-table textarea {
            min-height: 140px; 
            resize: vertical;
            font-size: 1.1rem !important; 
        }

        button {
            font-size: 1.1rem; 
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 z-50 flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 h-24 flex items-center justify-between">
            <div class="flex items-center gap-5">
                <div id="app-icon" class="w-14 h-14 rounded-xl bg-teal-600 text-white flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-user-doctor text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 leading-tight">CCC實務工作坊演練平台</h1>
                    <div class="text-sm text-slate-500 font-medium tracking-wider">CCC & REMEDIATION</div>
                </div>
            </div>
            <div class="bg-slate-100 px-5 py-2.5 rounded-full text-lg font-mono font-bold text-slate-600 border border-slate-200 flex items-center gap-3">
                <i class="fa-regular fa-clock text-slate-400"></i> <span id="global-timer">00:00</span>
            </div>
        </div>
        <div class="border-t border-slate-100 bg-white">
            <div class="max-w-7xl mx-auto px-4 flex gap-8 overflow-x-auto no-scrollbar">
                <button onclick="app.switchModule('ccc')" id="tab-ccc" class="nav-pill active text-teal-700 border-teal-600">
                    <i class="fa-solid fa-people-group mr-2"></i> CCC 演練
                </button>
                <button onclick="app.switchModule('remediation')" id="tab-remediation" class="nav-pill text-slate-500">
                    <i class="fa-solid fa-clipboard-list mr-2"></i> 補強計畫
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-1 overflow-y-auto bg-slate-50 scroll-smooth pb-32 lg:pb-10">
        <!-- Views injected here -->
    </main>

    <!-- Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="app.closeModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all scale-100 flex flex-col items-center text-center animate-fade-in" id="modal-content">
            <div id="modal-icon" class="w-20 h-20 rounded-full bg-slate-100 flex items-center justify-center mb-6 text-4xl">
                <i class="fa-solid fa-info"></i>
            </div>
            <h3 id="modal-title" class="text-3xl font-bold text-slate-800 mb-4">提示</h3>
            <p id="modal-message" class="text-slate-600 mb-8 text-xl leading-relaxed">內容</p>
            <div class="flex gap-4 w-full" id="modal-actions">
                <button id="modal-btn-cancel" class="flex-1 py-4 rounded-xl border border-slate-200 font-bold text-slate-600 text-xl">取消</button>
                <button id="modal-btn-confirm" class="flex-1 py-4 rounded-xl bg-teal-600 text-white font-bold shadow-lg shadow-teal-600/20 text-xl">確定</button>
            </div>
        </div>
    </div>

    <!-- 1. DASHBOARD -->
    <template id="tpl-dashboard">
        <div class="max-w-7xl mx-auto px-6 py-8 md:py-12 fade-in">
            <div class="mb-12 text-center md:text-left">
                <h2 class="text-4xl md:text-5xl font-black text-slate-800 tracking-tight mb-3" id="dashboard-title"></h2>
                <p class="text-slate-500 text-xl" id="dashboard-desc"></p>
                <div class="mt-8 inline-flex flex-wrap gap-4 bg-white px-8 py-4 rounded-full shadow-sm border border-slate-100 text-base md:text-lg">
                    <span class="flex items-center gap-2"><span class="w-4 h-4 rounded-full bg-slate-300"></span> 未開始</span>
                    <span class="flex items-center gap-2"><span class="w-4 h-4 rounded-full bg-yellow-400"></span> 進行中</span>
                    <span class="flex items-center gap-2"><span class="w-4 h-4 rounded-full bg-green-500"></span> 已完成</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8" id="dashboard-grid"></div>
        </div>
    </template>

    <!-- 2. CCC GROUP VIEW -->
    <template id="tpl-ccc-group">
        <div class="flex flex-col lg:flex-row h-full max-w-7xl mx-auto lg:px-6 lg:py-8 fade-in">
            <div class="lg:hidden step-scroll-container" id="mobile-step-list"></div>
            <!-- Sidebar -->
            <div class="hidden lg:flex flex-col w-64 bg-white rounded-l-2xl border border-slate-200 overflow-hidden shadow-sm flex-shrink-0 h-[calc(100vh-200px)]">
                <div class="p-6 sidebar-header flex justify-between items-start">
                    <div>
                        <div class="text-xs font-bold tracking-widest opacity-70 mb-1">CURRENT GROUP</div>
                        <h2 class="text-3xl font-bold" id="group-title-sidebar">第 1 組</h2>
                    </div>
                    <button onclick="app.loadDashboard()" class="text-sm bg-white/10 hover:bg-white/20 border border-white/20 px-3 py-1.5 rounded text-white transition flex items-center gap-1">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto" id="desktop-step-list"></div>
            </div>
            <div class="flex-1 flex flex-col bg-white lg:rounded-r-2xl lg:border-t lg:border-b lg:border-r border-slate-200 h-full lg:h-[calc(100vh-200px)] relative">
                <div class="px-10 py-8 border-b border-slate-100 bg-white sticky top-0 z-10">
                     <div class="lg:hidden mb-4">
                        <button onclick="app.loadDashboard()" class="text-base font-bold text-slate-400 flex items-center gap-2">
                            <i class="fa-solid fa-arrow-left"></i> 回總表
                        </button>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800 leading-tight" id="current-step-title"></h2>
                    <p class="text-lg text-slate-500 mt-2" id="current-step-desc"></p>
                </div>
                <div class="flex-1 overflow-y-auto p-8 md:p-12 space-y-10" id="step-content"></div>
                <div class="h-28 lg:hidden"></div>
                <div class="mobile-action-bar lg:absolute lg:bottom-0 lg:left-0 lg:right-0 lg:p-10 lg:bg-white lg:border-t lg:border-slate-100 justify-end">
                     <button id="next-step-btn" class="w-full lg:w-auto bg-teal-600 text-white px-12 py-5 rounded-xl font-bold shadow-lg shadow-teal-600/20 active:scale-95 transition flex items-center justify-center gap-3 text-xl">
                        下一步 <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- 3. REMEDIATION GROUP VIEW -->
    <template id="tpl-remediation-group">
        <div class="max-w-7xl mx-auto lg:px-6 lg:py-8 h-full flex flex-col fade-in">
            <!-- Header Area -->
            <div class="bg-white px-8 pt-8 pb-0 lg:rounded-t-2xl border-b border-slate-200 flex flex-col-reverse md:flex-row justify-between items-end gap-6 sticky top-0 lg:static z-10 shadow-sm lg:shadow-none">
                
                <!-- Left: Title & Back -->
                <div class="flex items-center gap-6 w-full md:w-auto pb-4">
                    <button onclick="app.loadDashboard()" class="w-14 h-14 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 flex-shrink-0">
                        <i class="fa-solid fa-arrow-turn-up transform rotate-90 text-2xl"></i>
                    </button>
                    <div>
                        <h2 class="font-bold text-slate-800 text-3xl" id="rem-group-title">第 1 組計畫</h2>
                        <p class="text-base text-slate-500 font-medium">Remediation Planning</p>
                    </div>
                </div>

                <!-- Right: Tabs -->
                <div class="flex gap-3 w-full md:w-auto overflow-x-auto no-scrollbar justify-end" id="rem-tabs-container">
                    <!-- Tabs will be rendered here by JS -->
                </div>
            </div>
            
            <div class="flex-1 lg:bg-white lg:border-x lg:border-b border-slate-200 lg:rounded-b-2xl overflow-hidden flex flex-col">
                <div class="flex-1 overflow-y-auto p-8 md:p-12 bg-slate-50 lg:bg-white">
                    
                    <!-- CCC 參考資訊區塊 -->
                    <div class="mb-12 bg-white border border-indigo-100 rounded-2xl shadow-sm overflow-hidden p-8 relative">
                        <div class="absolute top-0 left-0 w-3 h-full bg-indigo-500"></div>
                        <div class="flex items-center gap-4 mb-8 border-b border-slate-100 pb-5">
                            <div class="w-12 h-12 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                                <i class="fa-solid fa-file-contract text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-slate-800 text-2xl">CCC 決策參考資訊</h3>
                        </div>
                        
                        <div id="rem-ccc-reference">
                            <!-- Dynamic Content -->
                        </div>
                    </div>

                    <!-- 表格容器 -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                        <div class="p-8 border-b border-slate-200 bg-white flex justify-between items-center">
                            <h4 class="font-bold text-slate-800 flex items-center gap-3 text-xl">
                                <i class="fa-solid fa-list-check text-blue-500"></i> 補強計畫表
                            </h4>
                            <button onclick="app.addRemediationRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl text-lg font-bold shadow-md shadow-blue-600/20 transition flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> 新增
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full rem-table min-w-[1200px]">
                                <thead>
                                    <tr>
                                        <th class="w-[20%]">缺失/問題</th>
                                        <th class="w-[15%]">核心能力</th>
                                        <th class="w-[20%]">行動計畫</th>
                                        <th class="w-[15%]">評量方法</th>
                                        <th class="w-[15%]">目標</th>
                                        <th class="w-[10%]">期限</th>
                                        <th class="w-[5%]"></th>
                                    </tr>
                                </thead>
                                <tbody id="rem-table-body"></tbody>
                            </table>
                        </div>
                        <div id="rem-empty-state" class="text-center py-24 hidden bg-slate-50/50">
                            <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-6 text-slate-300 text-5xl shadow-sm border border-slate-100">
                                <i class="fa-solid fa-clipboard-question"></i>
                            </div>
                            <p class="text-slate-500 font-medium text-xl">尚無計畫內容，請點擊右上角新增</p>
                        </div>
                    </div>

                    <div class="h-32 lg:hidden"></div>
                </div>
            </div>

            <!-- Mobile Footer Actions -->
            <div class="mobile-action-bar lg:hidden justify-between gap-4">
                 <button onclick="app.addRemediationRow()" class="flex-1 bg-white border border-slate-300 text-slate-700 py-5 rounded-xl font-bold shadow-sm text-xl"><i class="fa-solid fa-plus mr-2"></i> 新增</button>
                <button onclick="app.completeRemediation()" class="flex-1 bg-indigo-600 text-white py-5 rounded-xl font-bold shadow-lg shadow-indigo-600/20 text-xl">提交</button>
            </div>
            <!-- Desktop Footer Actions -->
             <div class="hidden lg:flex absolute bottom-12 right-12 gap-8">
                <button onclick="app.completeRemediation()" class="bg-indigo-600 text-white px-12 py-5 rounded-full font-bold shadow-xl shadow-indigo-600/30 hover:bg-indigo-700 hover:scale-105 transition flex items-center gap-3 text-xl">
                    提交計畫 <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </template>

    <script>
        /* --- CONFIGURATION --- */
        const API_URL = "https://script.google.com/macros/s/AKfycbz-itROdnBGhhk0Ii7btFXFhV50B7846V0F5shjvm8Z4vcbh6r0UsRSieSpn0bW-CEztQ/exec"; 

        const CCC_STEPS = [
            { id: 1, title: "角色分配", duration: 5, desc: "確認委員會成員角色職責 (5 mins)", label: "STEP 1" },
            { id: 2, title: "查閱學習歷程", duration: 10, desc: "檢視學員 PGY 學習檔案 (10 mins)", label: "STEP 2 • 10 MINS" },
            { id: 3, title: "主席摘要", duration: 5, desc: "主席報告學員表現重點 (5 mins)", label: "STEP 3 • 5 MINS" },
            { id: 4, title: "品質面向討論", duration: 20, desc: "ARICH 品質面向深入討論 (20 mins)", label: "STEP 4 • 20 MINS" },
            { id: 5, title: "信賴決策與輔導", duration: 20, desc: "進行信賴決策與輔導計畫 (20 mins)", label: "STEP 5 • 20 MINS" },
            { id: 6, title: "觀察員紀錄", duration: 0, desc: "觀察員填寫回饋表單", label: "觀察員專區" }
        ];

        const ROLES = [
            { name: "CCC主席", count: 1, icon: "fa-gavel", desc: "經驗豐富的PGY資深臨床教師，任務是促進討論、統整觀點並引導決策流程，營造安全開放的對話氛圍。" },
            { name: "護理部教學負責人", count: 1, icon: "fa-clipboard-user", desc: "任職滿10年，透過教學系統掌握學員表現。知悉兩位學員的異常事件與回饋狀況。" },
            { name: "病房資深臨床教師", count: 1, icon: "fa-user-tie", desc: "20年經驗，負責學員臨床學習與生活輔導。對王大明的技術印象良好但擔憂團隊連結；肯定李小美的穩健但認為她偏保守。" },
            { name: "病房護理長", count: 1, icon: "fa-user-nurse", desc: "熟悉病房運作與教學。認為王大明雖主動但規範遵循有警訊；肯定李小美認真可靠且樂於修正。" },
            { name: "病房新任臨床教師", count: 1, icon: "fa-id-badge", desc: "新加入的指導教師。認為王大明能力足以授權，但互動較命令式；建議給李小美更多時間學習。" },
            { name: "觀察員", count: "N", icon: "fa-eye", desc: "依觀察表單紀錄會議流程、發言重點與決策過程。" }
        ];

        const OBSERVER_ITEMS = {
            "會議程序": ["主席有說明會議的目的與重點", "適當引導發言順序為「由幼至長」", "討論的過程展現意見的「多樣性」", "意見衝突時的處理機制"],
            "決策過程": ["決策考慮學員的專業素養 (ARICH)", "決策主要依據具體之「客觀事證」", "不受限於「階級」與「和諧」之框架", "達到「共享心智模式」之師培目的"]
        };

        const ARICH_CATS = [
            { id: 'integrity', label: '誠信', icon: 'fa-scale-balanced', desc: '誠實面對錯誤、仁慈' },
            { id: 'reliability', label: '可靠性', icon: 'fa-shield-halved', desc: '盡責、情緒穩定' },
            { id: 'humility', label: '謙遜', icon: 'fa-hand-holding-hand', desc: '辨識限制、主動求助' },
            { id: 'agency', label: '行動力', icon: 'fa-person-running', desc: '積極主動' }
        ];

        /* --- APP LOGIC --- */
        class App {
            constructor() {
                this.currentModule = 'ccc';
                this.groups = Array.from({ length: 8 }, (_, i) => ({
                    id: i + 1,
                    cccStep: 0,
                    cccCompleted: false,
                    students: {
                        daming: { name: "王大明", result: null, reason: "", plan: "", summary: "", qualityNote: "", remediationPlan: [] }, 
                        xiaomei: { name: "李小美", result: null, reason: "", plan: "", summary: "", qualityNote: "", remediationPlan: [] }  
                    },
                    activeStudentTab: 'daming', 
                    observerData: {}, 
                    remCompleted: false
                }));
                this.activeGroupId = null;
                this.secondsElapsed = 0;
                this.initTimer();
                this.switchModule('ccc');
            }

            initTimer() {
                setInterval(() => {
                    this.secondsElapsed++;
                    const min = Math.floor(this.secondsElapsed / 60).toString().padStart(2, '0');
                    const sec = (this.secondsElapsed % 60).toString().padStart(2, '0');
                    document.getElementById('global-timer').innerText = `${min}:${sec}`;
                }, 1000);
            }

            switchModule(mod) {
                this.currentModule = mod;
                this.activeGroupId = null;
                document.getElementById('tab-ccc').className = `nav-pill ${mod === 'ccc' ? 'active text-teal-700' : 'text-slate-500'}`;
                document.getElementById('tab-remediation').className = `nav-pill ${mod === 'remediation' ? 'active text-indigo-700' : 'text-slate-500'}`;
                document.documentElement.style.setProperty('--primary-color', mod === 'ccc' ? '#0d9488' : '#4f46e5');
                document.getElementById('app-icon').className = `w-14 h-14 rounded-xl ${mod === 'ccc' ? 'bg-teal-600' : 'bg-indigo-600'} text-white flex items-center justify-center shadow-sm`;
                this.loadDashboard();
            }

            loadDashboard() {
                this.activeGroupId = null;
                const tpl = document.getElementById('tpl-dashboard');
                const container = document.getElementById('main-container');
                container.innerHTML = '';
                container.appendChild(tpl.content.cloneNode(true));
                
                // Scroll to top on view change
                container.scrollTop = 0;

                const isCCC = this.currentModule === 'ccc';
                document.getElementById('dashboard-title').innerText = isCCC ? "CCC 臨床能力委員會演練" : "補強計畫設計演練";
                document.getElementById('dashboard-desc').innerText = isCCC ? "即時監控 8 個小組的討論進度與決策結果" : "針對學員缺失設計具體行動方案 (Remediation)";
                document.getElementById('dashboard-title').className = `text-2xl md:text-3xl font-black ${isCCC ? 'text-teal-900' : 'text-indigo-900'} tracking-tight`;

                const grid = document.getElementById('dashboard-grid');
                this.groups.forEach(g => grid.appendChild(this.createCard(g)));
            }

            createCard(g) {
                const div = document.createElement('div');
                div.className = "dashboard-card cursor-pointer group";
                div.onclick = () => this.loadGroup(g.id);
                const isCCC = this.currentModule === 'ccc';
                
                let progress = 0, statusColor = "bg-slate-300", statusText = "未開始";
                
                if (isCCC) {
                    if (g.cccCompleted) { 
                        progress = 100; 
                        statusColor = "bg-green-500"; 
                        statusText = "已完成"; 
                    } 
                    else if (g.cccStep > 0 || this.hasEnteredData(g)) { 
                        progress = Math.min(90, (g.cccStep / 5) * 100); 
                        statusColor = "bg-yellow-400"; 
                        statusText = "進行中"; 
                    }
                } else {
                    if (g.remCompleted) { 
                        progress = 100; 
                        statusColor = "bg-green-500"; 
                        statusText = "完成"; 
                    }
                    else if (g.students.daming.remediationPlan.length > 0 || g.students.xiaomei.remediationPlan.length > 0) { 
                        progress = 50; 
                        statusColor = "bg-yellow-400"; 
                        statusText = "進行中"; 
                    }
                }

                div.innerHTML = `
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="font-bold text-2xl text-slate-800">第 ${g.id} 組</h3>
                            <div class="flex items-center gap-2 text-base font-bold text-slate-500">
                                <span class="w-4 h-4 rounded-full ${statusColor}"></span> ${statusText}
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-4 mb-8 overflow-hidden">
                            <div class="h-full ${isCCC ? 'bg-teal-500' : 'bg-indigo-500'} transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-lg text-slate-400 flex justify-between items-center">
                            <span>${isCCC ? (g.cccCompleted ? '演練結束' : (g.cccStep >= 5 ? '信賴決策中' : CCC_STEPS[g.cccStep].title)) : (g.remCompleted ? '計畫已提交' : '編輯中...')}</span>
                            <i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-slate-600 transition-colors text-xl"></i>
                        </div>
                    </div>
                `;
                return div;
            }

            hasEnteredData(group) {
                const checkStudent = (s) => s.summary || s.reason || s.plan || s.qualityNote || s.result !== null;
                return checkStudent(group.students.daming) || checkStudent(group.students.xiaomei);
            }

            loadGroup(id) {
                this.activeGroupId = id;
                const container = document.getElementById('main-container');
                container.innerHTML = '';
                
                // Scroll to top on view change
                container.scrollTop = 0;

                if (this.currentModule === 'ccc') {
                    const tpl = document.getElementById('tpl-ccc-group');
                    container.appendChild(tpl.content.cloneNode(true));
                    this.renderCCC();
                } else {
                    const tpl = document.getElementById('tpl-remediation-group');
                    container.appendChild(tpl.content.cloneNode(true));
                    this.renderRemediation();
                }
            }

            renderCCC() {
                const g = this.groups[this.activeGroupId - 1];
                document.getElementById('group-title-sidebar').innerText = `第 ${g.id} 組`;
                
                const renderSteps = (containerId, isMobile) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    CCC_STEPS.forEach((s, i) => {
                        const isActive = i === g.cccStep;
                        const el = document.createElement('div');
                        if (isMobile) {
                            el.className = `step-pill ${isActive ? 'active' : ''}`;
                            el.innerText = `${i+1}. ${s.title}`;
                        } else {
                            el.className = `sidebar-item ${isActive ? 'active' : ''}`;
                            el.innerHTML = `<div class="label">${s.label}</div><div class="title">${s.title}</div>`;
                        }
                        el.onclick = () => { 
                            g.cccStep = i; 
                            this.renderCCC(); 
                            // Scroll content to top when step changes
                            document.getElementById('step-content').parentElement.scrollTop = 0;
                        };
                        container.appendChild(el);
                    });
                };
                renderSteps('mobile-step-list', true);
                renderSteps('desktop-step-list', false);

                const step = CCC_STEPS[g.cccStep];
                document.getElementById('current-step-title').innerText = step.title;
                document.getElementById('current-step-desc').innerText = step.desc;

                const contentDiv = document.getElementById('step-content');
                contentDiv.innerHTML = this.getCCCContentHTML(g.cccStep + 1);

                const btn = document.getElementById('next-step-btn');
                if (g.cccStep === 5) {
                    btn.innerHTML = '返回儀表板';
                    btn.className = "w-full lg:w-auto bg-white text-slate-600 border border-slate-300 px-8 py-3.5 rounded-xl font-bold shadow-sm";
                    btn.onclick = () => this.loadDashboard();
                } else if (g.cccStep === 4) {
                    btn.innerHTML = '完成演練';
                    btn.className = "w-full lg:w-auto bg-slate-800 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg";
                    btn.onclick = () => this.completeCCCGroupSimulation();
                } else {
                    btn.innerHTML = '下一步 <i class="fa-solid fa-arrow-right ml-2"></i>';
                    btn.onclick = () => { 
                        g.cccStep++; 
                        this.renderCCC(); 
                        // Scroll content to top when step changes
                        document.getElementById('step-content').parentElement.scrollTop = 0;
                    };
                }
            }

            getTabsHTML(activeKey, showLabel = false) {
                const labelPrefix = showLabel ? "" : "";
                const commonBtn = "px-8 py-3 rounded-t-xl font-bold transition-all text-lg flex-1 md:flex-none flex items-center justify-center border-b-0";
                const damingActive = "bg-blue-600 text-white shadow-md transform -translate-y-1"; 
                const xiaomeiActive = "bg-pink-600 text-white shadow-md transform -translate-y-1";
                const inactive = "bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700";

                return `
                <div class="flex gap-3 border-b border-slate-200 mb-6 px-2">
                    <button onclick="app.setTab('daming')" class="${commonBtn} ${activeKey==='daming' ? damingActive : inactive}">
                        <i class="fa-solid fa-user-nurse mr-2"></i> ${labelPrefix}王大明
                    </button>
                    <button onclick="app.setTab('xiaomei')" class="${commonBtn} ${activeKey==='xiaomei' ? xiaomeiActive : inactive}">
                        <i class="fa-solid fa-user-nurse mr-2"></i> ${labelPrefix}李小美
                    </button>
                </div>`;
            }

            getCCCContentHTML(stepId) {
                const g = this.groups[this.activeGroupId - 1];
                const activeKey = g.activeStudentTab;
                
                if (stepId === 1) {
                    return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${ROLES.map(r => `<div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition"><div class="flex items-center gap-4 mb-4"><div class="w-12 h-12 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center"><i class="fa-solid ${r.icon} text-2xl"></i></div><div><h4 class="font-bold text-slate-800 text-lg">${r.name}</h4><span class="text-sm bg-slate-100 px-3 py-1 rounded text-slate-500">人數: ${r.count}</span></div></div><p class="text-base text-slate-600 leading-relaxed">${r.desc}</p></div>`).join('')}</div>`;
                }
                if (stepId === 2) return `<div class="text-center py-16"><i class="fa-solid fa-book-open text-7xl text-slate-200 mb-8 block"></i><h3 class="text-2xl font-bold text-slate-700 mb-3">請委員參閱 2 位學員的學習歷程檔案</h3><p class="text-slate-500 mb-10 text-lg">請全體委員參閱紙本或平板上的學習歷程資料。</p><div class="flex justify-center gap-6"><button class="px-8 py-4 rounded-xl border border-slate-200 font-bold text-slate-600 bg-white shadow-sm hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition text-lg">王大明資料</button><button class="px-8 py-4 rounded-xl border border-slate-200 font-bold text-slate-600 bg-white shadow-sm hover:bg-pink-50 hover:text-pink-600 hover:border-pink-200 transition text-lg">李小美資料</button></div></div>`;
                if (stepId === 3) {
                    return `${this.getTabsHTML(activeKey)}<div class="bg-white border border-slate-200 rounded-b-xl rounded-tr-xl p-8 shadow-sm animate-fade-in"><div class="flex items-center gap-3 mb-4 border-b border-slate-100 pb-3"><div class="w-1.5 h-6 ${activeKey === 'daming' ? 'bg-blue-600' : 'bg-pink-600'} rounded-full"></div><div class="font-bold text-slate-800 text-xl">${g.students[activeKey].name} 摘要</div></div><textarea class="w-full h-80 bg-slate-50 border-slate-200 focus:bg-white" placeholder="請自由輸入學員職場表現..." oninput="app.updateData('${activeKey}','summary',this.value)">${g.students[activeKey].summary}</textarea></div>`;
                }
                if (stepId === 4) {
                    return `
                    <!-- 上方參考卡片 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                        ${ARICH_CATS.map(cat => `
                            <div class="bg-white p-6 rounded-xl border border-slate-200 text-center shadow-sm">
                                <div class="w-12 h-12 mx-auto rounded-full bg-teal-50 text-teal-600 flex items-center justify-center text-2xl mb-3"> 
                                    <i class="fa-solid ${cat.icon}"></i>
                                </div>
                                <div class="font-bold text-slate-800 text-lg">${cat.label}</div>
                                <div class="text-sm text-slate-500">${cat.desc}</div>
                            </div>
                        `).join('')}
                    </div>

                    ${this.getTabsHTML(activeKey)}

                    <!-- 下方輸入區 (單一欄位) -->
                    <div class="bg-white p-8 rounded-b-xl rounded-tr-xl border border-slate-200 shadow-sm animate-fade-in">
                        <div class="mb-6 flex items-center gap-3">
                            <span class="px-4 py-1.5 rounded text-base font-bold text-white ${activeKey === 'daming' ? 'bg-blue-600' : 'bg-pink-600'}">${g.students[activeKey].name}</span>
                            <h4 class="text-xl font-bold text-slate-800">品質面向討論紀錄</h4>
                        </div>
                        <textarea class="w-full h-80 bg-slate-50 border-slate-200 focus:bg-white p-6 rounded-xl text-lg" 
                            placeholder="請記錄針對 ${g.students[activeKey].name} 的 ARICH 面向討論..." 
                            oninput="app.updateData('${activeKey}', 'qualityNote', this.value)">${g.students[activeKey].qualityNote}</textarea>
                    </div>`;
                }
                if (stepId === 5) {
                    const s = g.students[activeKey];
                    return `${this.getTabsHTML(activeKey)}<div class="bg-white p-8 rounded-b-xl rounded-tr-xl border border-slate-200 shadow-sm animate-fade-in"><div class="mb-10"><h4 class="font-bold text-slate-800 mb-4 border-l-4 border-teal-500 pl-4 text-xl">是否可被信賴執行該 EPA「住院病患的照護與衛教」？</h4><div class="flex gap-4"><button class="flex-1 py-5 rounded-xl border-2 font-bold text-xl ${s.result===true?'border-green-500 bg-green-50 text-green-700':'border-slate-200 text-slate-400'}" onclick="app.setResult(true)">Pass 可信賴</button><button class="flex-1 py-5 rounded-xl border-2 font-bold text-xl ${s.result===false?'border-red-500 bg-red-50 text-red-700':'border-slate-200 text-slate-400'}" onclick="app.setResult(false)">Fail 未通過</button></div></div><div class="space-y-10"><div><h4 class="font-bold text-slate-800 mb-3 border-l-4 border-teal-500 pl-4 text-xl">擬定向學員說明此決定的原因？</h4><textarea class="w-full h-40" placeholder="請說明..." oninput="app.updateData('${activeKey}','reason',this.value)">${s.reason}</textarea></div><div><h4 class="font-bold text-slate-800 mb-3 border-l-4 border-teal-500 pl-4 text-xl">提出具體輔導方案或改善計畫？</h4><textarea class="w-full h-40" placeholder="請說明..." oninput="app.updateData('${activeKey}','plan',this.value)">${s.plan}</textarea></div></div></div>`;
                }
                if (stepId === 6) {
                    // Simplified Observer View
                    return `
                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="mb-8 border-b border-slate-100 pb-6">
                            <h3 class="font-bold text-slate-800 text-3xl text-blue-600">觀察員紀錄</h3>
                            <p class="text-lg text-slate-500 mt-2">填寫回饋表單</p>
                        </div>
                        
                        ${this.getTabsHTML(activeKey)}

                        <div class="bg-slate-50 p-6 rounded-b-xl rounded-tr-xl border border-slate-200 space-y-10 animate-fade-in">
                            ${Object.entries(OBSERVER_ITEMS).map(([category, items], catIdx) => `
                                <div>
                                    <h5 class="font-bold text-slate-800 text-xl mb-4 flex items-center gap-3">
                                        <span class="bg-slate-200 w-8 h-8 flex items-center justify-center rounded text-sm">${catIdx+1}</span> ${category}
                                    </h5>
                                    <ul class="list-disc pl-10 mb-6 text-base text-slate-600 space-y-2">
                                        ${items.map(i => `<li>${i}</li>`).join('')}
                                    </ul>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="text-sm font-bold text-slate-500 mb-2 block">實際觀察到的團隊作為</label>
                                            <textarea class="h-40 text-base" placeholder="請描述..." oninput="app.updateObs('${activeKey}', '${category}-actual', this.value)">${g.observerData[`${activeKey}-${category}-actual`] || ''}</textarea>
                                        </div>
                                        <div>
                                            <label class="text-sm font-bold text-slate-500 mb-2 block">潛在的挑戰與限制</label>
                                            <textarea class="h-40 text-base" placeholder="請描述..." oninput="app.updateObs('${activeKey}', '${category}-limit', this.value)">${g.observerData[`${activeKey}-${category}-limit`] || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
            }

            renderRemediation() {
                const g = this.groups[this.activeGroupId - 1];
                const key = g.activeStudentTab;
                
                // Tabs: Render unified tabs in the header container
                const commonBtn = "px-8 py-3 rounded-t-xl font-bold transition-all text-base flex-1 md:flex-none flex items-center justify-center border-b-0";
                const damingActive = "bg-blue-600 text-white shadow-md transform -translate-y-1"; 
                const xiaomeiActive = "bg-pink-600 text-white shadow-md transform -translate-y-1";
                const inactive = "bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700";

                const damingBtn = `<button onclick="app.switchStudentTab('daming')" class="${commonBtn} ${key==='daming' ? damingActive : inactive}"><i class="fa-solid fa-user-nurse mr-2"></i> 王大明</button>`;
                const xiaomeiBtn = `<button onclick="app.switchStudentTab('xiaomei')" class="${commonBtn} ${key==='xiaomei' ? xiaomeiActive : inactive}"><i class="fa-solid fa-user-nurse mr-2"></i> 李小美</button>`;

                // Fix for TypeError: Check if element exists before setting innerHTML
                const remTabsContainer = document.getElementById('rem-tabs-container');
                if (remTabsContainer) {
                    remTabsContainer.innerHTML = damingBtn + xiaomeiBtn;
                }

                // Fix for TypeError: Check if elements exist
                const remGroupTitle = document.getElementById('rem-group-title');
                if (remGroupTitle) remGroupTitle.innerText = `第 ${g.id} 組計畫`;
                
                const remGroupTitleMobile = document.getElementById('rem-group-title-mobile');
                if (remGroupTitleMobile) remGroupTitleMobile.innerText = `第 ${g.id} 組計畫`;

                const s = g.students[key];
                const resultBadge = s.result === true 
                    ? '<span class="bg-green-100 text-green-700 px-4 py-1.5 rounded-full text-sm font-bold border border-green-200 flex items-center gap-2"><i class="fa-solid fa-check-circle"></i> PASS 可信賴</span>' 
                    : s.result === false 
                        ? '<span class="bg-red-100 text-red-700 px-4 py-1.5 rounded-full text-sm font-bold border border-red-200 flex items-center gap-2"><i class="fa-solid fa-circle-xmark"></i> FAIL 未通過</span>' 
                        : '<span class="bg-slate-100 text-slate-500 px-4 py-1.5 rounded-full text-xs font-bold border border-slate-200">尚未決策</span>';

                const refHTML = `
                    <div class="flex items-center gap-6 mb-6">
                        <span class="text-base font-bold text-slate-500">CCC 信賴決策結果</span>
                        ${resultBadge}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-slate-200 rounded-xl p-6 bg-white">
                            <h5 class="font-bold text-slate-700 mb-3 text-base flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-orange-400"></span> 決策原因
                            </h5>
                            <p class="text-base text-slate-600 whitespace-pre-wrap leading-relaxed">${s.reason || '尚無內容'}</p>
                        </div>
                        <div class="border border-slate-200 rounded-xl p-6 bg-white">
                            <h5 class="font-bold text-slate-700 mb-3 text-base flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-indigo-400"></span> 輔導方案建議
                            </h5>
                            <p class="text-base text-slate-600 whitespace-pre-wrap leading-relaxed">${s.plan || '尚無內容'}</p>
                        </div>
                    </div>
                `;
                
                const cccRefContainer = document.getElementById('rem-ccc-reference');
                if (cccRefContainer) cccRefContainer.innerHTML = refHTML;

                const container = document.getElementById('rem-table-body');
                if (container) {
                    container.innerHTML = '';
                    
                    const emptyState = document.getElementById('rem-empty-state');
                    if (s.remediationPlan.length === 0) {
                        if (emptyState) emptyState.classList.remove('hidden');
                    } else {
                        if (emptyState) emptyState.classList.add('hidden');
                        s.remediationPlan.forEach((item, idx) => {
                            const tr = document.createElement('tr');
                            tr.className = "group hover:bg-slate-50 transition-colors";
                            tr.innerHTML = `
                                <td><textarea class="bg-white focus:bg-indigo-50/30" oninput="app.updateItem(${idx},'deficit',this.value)">${item.deficit}</textarea></td>
                                <td><textarea class="bg-white focus:bg-indigo-50/30" oninput="app.updateItem(${idx},'competency',this.value)">${item.competency}</textarea></td>
                                <td><textarea class="bg-white focus:bg-indigo-50/30" oninput="app.updateItem(${idx},'action',this.value)">${item.action}</textarea></td>
                                <td><textarea class="bg-white focus:bg-indigo-50/30" oninput="app.updateItem(${idx},'assessment',this.value)">${item.assessment}</textarea></td>
                                <td><textarea class="bg-white focus:bg-indigo-50/30" oninput="app.updateItem(${idx},'goal',this.value)">${item.goal}</textarea></td>
                                <td><textarea class="bg-white focus:bg-indigo-50/30 h-[140px]" oninput="app.updateItem(${idx},'deadline',this.value)">${item.deadline}</textarea></td>
                                <td class="align-middle text-center"><button onclick="app.delItem(${idx})" class="text-slate-300 hover:text-red-500 w-10 h-10 rounded-full hover:bg-red-50 transition"><i class="fa-solid fa-trash-can text-xl"></i></button></td>
                            `;
                            container.appendChild(tr);
                        });
                    }
                }
            }

            async sendDataToGoogleSheet(group, type) {
                if (!API_URL) {
                    console.warn("Google Apps Script URL 未設定，跳過資料傳送。");
                    return;
                }

                const timestamp = new Date().toLocaleString('zh-TW');
                
                // 1. 準備 CCC Master Log 資料 (兩位學員)
                if (type === 'ccc') {
                    const masterData = [];
                    ['daming', 'xiaomei'].forEach(key => {
                        const s = group.students[key];
                        const obsProcessActual = group.observerData[`${key}-會議程序-actual`] || '無紀錄';
                        const obsProcessLimit = group.observerData[`${key}-會議程序-limit`] || '無紀錄';
                        const obsDecisionActual = group.observerData[`${key}-決策過程-actual`] || '無紀錄';
                        const obsDecisionLimit = group.observerData[`${key}-決策過程-limit`] || '無紀錄';

                        // 整合觀察員紀錄為單一字串
                        const obsLog = `【會議程序】\n• 實際: ${obsProcessActual}\n• 限制: ${obsProcessLimit}\n\n【決策過程】\n• 實際: ${obsDecisionActual}\n• 限制: ${obsDecisionLimit}`;

                        masterData.push([
                            timestamp,
                            `第 ${group.id} 組`,
                            s.name,
                            s.summary || '-',
                            s.qualityNote || '-', // Step 4 單一欄位
                            s.result === true ? 'PASS' : (s.result === false ? 'FAIL' : '未決策'),
                            s.reason || '-',
                            s.plan || '-',
                            obsLog, // Step 6 單一欄位
                            group.cccCompleted ? '已完成' : '進行中'
                        ]);
                    });

                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sheet: 'CCC_Master_Log', data: masterData })
                        });
                        console.log("CCC 資料已傳送至 Google Sheets");
                    } catch (error) {
                        console.error("CCC 資料傳送失敗:", error);
                    }
                }

                // 2. 準備 Remediation Details 資料
                if (type === 'remediation') {
                    const remData = [];
                    ['daming', 'xiaomei'].forEach(key => {
                        const s = group.students[key];
                        if (s.remediationPlan && s.remediationPlan.length > 0) {
                            s.remediationPlan.forEach(item => {
                                remData.push([
                                    timestamp,
                                    `第 ${group.id} 組`,
                                    s.name,
                                    item.deficit || '-',
                                    item.competency || '-',
                                    item.action || '-',
                                    item.assessment || '-',
                                    item.goal || '-',
                                    item.deadline || '-'
                                ]);
                            });
                        }
                    });

                    try {
                        if (remData.length > 0) {
                            await fetch(API_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ sheet: 'Remediation_Details', data: remData })
                            });
                            console.log("補強計畫資料已傳送至 Google Sheets");
                        }
                    } catch (error) {
                        console.error("補強計畫資料傳送失敗:", error);
                    }
                }
            }

            setTab(t) { 
                this.groups[this.activeGroupId-1].activeStudentTab = t; 
                // Check current view and render appropriately to avoid null errors
                if(this.currentModule === 'ccc') {
                    this.renderCCC(); 
                } else {
                    this.renderRemediation();
                }
                
                // Scroll content to top when tab changes
                const contentDiv = document.getElementById('step-content');
                if (contentDiv && contentDiv.parentElement) {
                   contentDiv.parentElement.scrollTop = 0;
                }
                // For remediation view
                const remContent = document.querySelector('.flex-1.overflow-y-auto');
                if (remContent) remContent.scrollTop = 0;
            }
            
            setResult(r) { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].result = r; this.renderCCC(); }
            updateData(s,f,v) { this.groups[this.activeGroupId-1].students[s][f] = v; }
            updateArich(s, field, v) { this.groups[this.activeGroupId-1].students[s].qualityNote = v; }
            updateObs(s, key, v) { this.groups[this.activeGroupId-1].observerData[`${s}-${key}`] = v; }
            
            switchStudentTab(t) { 
                // Unified switcher that just calls setTab
                this.setTab(t);
            }
            
            addRemediationRow() { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan.push({deficit:'',competency:'',action:'',assessment:'',goal:'',deadline:''}); this.renderRemediation(); }
            updateItem(idx,f,v) { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan[idx][f] = v; }
            delItem(idx) { if(confirm('刪除此項目?')) { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan.splice(idx,1); this.renderRemediation(); } }
            
            completeRemediation() {
                const group = this.groups[this.activeGroupId - 1];
                const hasContent = (studentKey) => {
                    const plan = group.students[studentKey].remediationPlan;
                    return plan && plan.length > 0 && plan.some(row => Object.values(row).some(val => val && val.trim().length > 0));
                };
                const damingReady = hasContent('daming');
                const xiaomeiReady = hasContent('xiaomei');
                const count = (damingReady ? 1 : 0) + (xiaomeiReady ? 1 : 0);

                if (count === 2) {
                    this.showModal({
                        title: "完成計畫設計",
                        message: "兩位學員的計畫皆已設計完成。<br>確定要提交並返回儀表板嗎？",
                        type: 'success',
                        onConfirm: () => {
                            group.remCompleted = true;
                            this.sendDataToGoogleSheet(group, 'remediation'); // Send only remediation data
                            this.loadDashboard();
                        }
                    });
                } else if (count === 1) {
                    this.showModal({
                        title: "計畫未完全結束",
                        message: "提醒還有1位的計畫尚未完成",
                        type: 'warning',
                        onConfirm: () => {
                            this.sendDataToGoogleSheet(group, 'remediation'); // Send only remediation data
                            this.loadDashboard();
                        }
                    });
                } else {
                    this.showModal({
                        title: "無法提交計畫",
                        message: "請至少為一位學員新增並填寫補強計畫後再提交。",
                        type: 'warning'
                    });
                }
            }

            closeModal() { document.getElementById('custom-modal').classList.add('hidden'); }

            showModal({ title, message, icon, type, onConfirm }) {
                const modal = document.getElementById('custom-modal');
                const titleEl = document.getElementById('modal-title');
                const msgEl = document.getElementById('modal-message');
                const iconContainer = document.getElementById('modal-icon');
                const btnCancel = document.getElementById('modal-btn-cancel');
                const btnConfirm = document.getElementById('modal-btn-confirm');

                titleEl.innerHTML = title;
                msgEl.innerHTML = message;
                
                if (type === 'success') {
                    iconContainer.innerHTML = '<i class="fa-solid fa-check text-green-600 text-xl"></i>';
                    iconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 md:h-24 md:w-24 rounded-full bg-green-100 mb-6 md:mb-8 shadow-sm";
                    btnConfirm.className = "bg-green-600 text-white hover:bg-green-700 px-6 md:px-8 py-3 md:py-4 rounded-xl text-base md:text-lg font-bold shadow-lg transition w-full transform hover:-translate-y-0.5";
                } else if (type === 'warning') {
                    iconContainer.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-yellow-600 text-xl"></i>';
                    iconContainer.className = "mx-auto flex items-center justify-center h-20 w-20 md:h-24 md:w-24 rounded-full bg-yellow-100 mb-6 md:mb-8 shadow-sm";
                    btnConfirm.className = "bg-yellow-600 text-white hover:bg-yellow-700 px-6 md:px-8 py-3 md:py-4 rounded-xl text-base md:text-lg font-bold shadow-lg transition w-full transform hover:-translate-y-0.5";
                }

                if (onConfirm) {
                    btnCancel.classList.remove('hidden');
                    btnConfirm.onclick = () => { this.closeModal(); onConfirm(); };
                } else {
                    btnCancel.classList.add('hidden');
                    btnConfirm.onclick = () => this.closeModal();
                }

                btnCancel.onclick = () => this.closeModal();
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modal.querySelector('#modal-content').classList.add('scale-100');
                }, 10);
            }

            completeCCCGroupSimulation() {
                const group = this.groups[this.activeGroupId - 1];
                const p1 = group.students.daming.result;
                const p2 = group.students.xiaomei.result;
                const count = (p1 !== null ? 1 : 0) + (p2 !== null ? 1 : 0);

                if (count === 2) {
                    this.showModal({
                        title: "確認結束演練", message: "兩位學員皆已評定完成。<br>確定要結束本組演練並返回儀表板嗎？", type: 'success',
                        onConfirm: () => { 
                            group.cccCompleted = true; 
                            this.sendDataToGoogleSheet(group, 'ccc'); // Send only CCC data
                            this.loadDashboard(); 
                        }
                    });
                } else if (count === 1) {
                    this.showModal({
                        title: "演練未完全結束", message: "提醒還有1位的演練尚未完成", type: 'warning',
                        onConfirm: () => { 
                            this.sendDataToGoogleSheet(group, 'ccc'); // Send only CCC data
                            this.loadDashboard(); 
                        }
                    });
                } else {
                    this.showModal({ title: "無法結束演練", message: "請至少完成一位學員的信賴決策(Pass/Fail)後再送出。", type: 'warning' });
                }
            }
        }

        const app = new App();
    </script>
</body>
</html>
