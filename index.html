<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CCC實務工作坊演練平台 V5.7 (完整修復版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --primary-teal: #0d9488;
            --primary-indigo: #4f46e5;
            --primary-adapt: #ED7D31;
            --bg-slate: #f8fafc;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-slate); 
            line-height: 1.6; 
            -webkit-tap-highlight-color: transparent;
            font-size: 16px; 
            color: #334155;
            height: 100vh;
            overflow: hidden;
        }

        /* === Utilities === */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* === Components === */
        .dashboard-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(226, 232, 240, 1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .dashboard-card:active { transform: scale(0.98); }
        @media (min-width: 768px) {
            .dashboard-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.05);
                border-color: rgba(148, 163, 184, 0.3);
            }
        }

        /* Step Navigation */
        .step-scroll-container { display: flex; overflow-x: auto; gap: 0.5rem; padding: 0.75rem; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 20; }
        .step-pill { flex: 0 0 auto; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.9rem; font-weight: 600; color: #64748b; background: #f1f5f9; border: 1px solid #e2e8f0; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
        .step-pill.active { background: #0f766e; color: white; border-color: #0f766e; box-shadow: 0 4px 6px -1px rgba(15, 118, 110, 0.2); }

        /* Sidebar */
        .sidebar-header { background-color: #115e59; color: white; }
        .sidebar-item { padding: 0.85rem 1.25rem; border-left: 4px solid transparent; cursor: pointer; transition: all 0.2s ease; }
        .sidebar-item:hover { background-color: #f8fafc; }
        .sidebar-item.active { background-color: #f0fdfa; border-left-color: #0d9488; }
        .sidebar-item .label { font-size: 0.65rem; font-weight: 800; letter-spacing: 0.05em; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.1rem; }
        .sidebar-item.active .label { color: #2dd4bf; }
        .sidebar-item .title { font-size: 0.9rem; font-weight: 700; color: #334155; }
        .sidebar-item.active .title { color: #0f766e; }

        /* Optimized Inputs */
        textarea, input[type="text"] { 
            font-size: 1rem !important; 
            border-radius: 12px; 
            border: 1px solid #cbd5e1; 
            padding: 12px; 
            width: 100%; 
            transition: all 0.2s; 
            line-height: 1.5;
            background-color: #fcfcfc;
        }
        textarea:focus, input:focus { 
            outline: none; 
            border-color: var(--primary-indigo); 
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); 
            background-color: #fff;
        }
        .textarea-fill {
            height: 100%;
            min-height: 150px;
            resize: none;
        }
        .auto-expand { 
            min-height: 100px; 
            overflow-y: hidden;
            resize: none; 
        }

        /* Mobile Action Bar */
        .mobile-action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); padding: 12px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 40; border-top: 1px solid #f1f5f9; display: flex; gap: 12px; }
        @media (min-width: 1024px) { .mobile-action-bar { position: static; box-shadow: none; border-top: none; padding: 0; background: transparent; } }

        /* Nav Pills */
        .nav-pill { position: relative; padding: 0.8rem 1.5rem; font-weight: 700; font-size: 1rem; color: #64748b; transition: color 0.3s; cursor: pointer; white-space: nowrap; }
        .nav-pill.active { color: #0f172a; }
        .nav-pill.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 4px; background: currentColor; border-radius: 3px 3px 0 0; }

        /* Tables */
        .rem-table th { background-color: #f8fafc; color: #475569; font-weight: 800; text-transform: uppercase; font-size: 0.85rem; padding: 1rem; border-bottom: 2px solid #e2e8f0; white-space: nowrap; text-align: left; }
        .rem-table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .rem-table textarea { min-height: 80px; resize: vertical; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999;
            display: flex; flex-col; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0d9488; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ADAPT Custom Colors */
        .text-adapt { color: #ED7D31; }
        .bg-adapt { background-color: #ED7D31; }
        .border-adapt { border-color: #ED7D31; }
        .hover-bg-adapt:hover { background-color: #d06015; }
        
        button { font-size: 1rem; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <div class="text-xl font-bold text-slate-600">正在同步資料庫...</div>
        <div class="text-sm text-slate-400 mt-2">請稍候，正在讀取最新的演練進度</div>
    </div>

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 z-50 flex-shrink-0">
        <div class="w-full px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div id="app-icon" class="w-10 h-10 rounded-lg bg-teal-600 text-white flex items-center justify-center shadow-sm transition-colors duration-300">
                    <i class="fa-solid fa-user-doctor text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-slate-800 leading-tight">CCC實務工作坊演練平台</h1>
                    <div class="text-xs text-slate-500 font-medium tracking-wider">CCC & REMEDIATION V5.7</div>
                </div>
            </div>
            <div class="bg-slate-100 px-3 py-1.5 rounded-full text-sm font-mono font-bold text-slate-600 border border-slate-200 flex items-center gap-2">
                <i class="fa-regular fa-clock text-slate-400"></i> <span id="global-timer">00:00</span>
            </div>
        </div>
        <div class="border-t border-slate-100 bg-white">
            <div class="w-full px-6 flex gap-4 overflow-x-auto no-scrollbar">
                <button onclick="app.switchModule('ccc')" id="tab-ccc" class="nav-pill active text-teal-700 border-teal-600">
                    <i class="fa-solid fa-people-group mr-2"></i> CCC 演練
                </button>
                <button onclick="app.switchModule('remediation')" id="tab-remediation" class="nav-pill text-slate-500">
                    <i class="fa-solid fa-clipboard-list mr-2"></i> 補強計畫
                </button>
                <button onclick="app.switchModule('adapt')" id="tab-adapt" class="nav-pill text-slate-500">
                    <i class="fa-solid fa-comments mr-2"></i> ADAPT 回饋
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-1 overflow-hidden bg-slate-50 relative">
        <!-- Views injected here -->
    </main>

    <!-- Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="app.closeModal()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg transform transition-all scale-100 flex flex-col items-center text-center animate-fade-in" id="modal-content">
            <div id="modal-icon" class="w-20 h-20 rounded-full bg-slate-100 flex items-center justify-center mb-6 text-4xl flex-shrink-0">
                <i class="fa-solid fa-info"></i>
            </div>
            <div class="w-full mb-8">
                 <h3 id="modal-title" class="text-3xl font-bold text-slate-800 mb-4">提示</h3>
                 <div id="modal-message" class="text-slate-600 text-xl leading-relaxed text-left">內容</div>
            </div>
            <div class="flex gap-4 w-full" id="modal-actions">
                <button id="modal-btn-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 text-lg">取消</button>
                <button id="modal-btn-confirm" class="flex-1 py-3 rounded-xl bg-teal-600 text-white font-bold shadow-lg shadow-teal-600/20 hover:bg-teal-700 text-lg">確定</button>
            </div>
        </div>
    </div>

    <!-- 1. DASHBOARD TEMPLATE -->
    <template id="tpl-dashboard">
        <div class="w-full h-full overflow-y-auto px-8 py-10 fade-in">
            <div class="mb-10 text-center md:text-left">
                <h2 class="text-4xl font-black text-slate-800 tracking-tight mb-3" id="dashboard-title"></h2>
                <p class="text-slate-500 text-xl" id="dashboard-desc"></p>
                <div class="mt-6 inline-flex flex-wrap gap-4 bg-white px-6 py-3 rounded-full shadow-sm border border-slate-100 text-base">
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-300"></span> 未開始</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> 進行中</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> 已完成</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 pb-20" id="dashboard-grid"></div>
        </div>
    </template>

    <!-- 2. CCC GROUP VIEW -->
    <template id="tpl-ccc-group">
        <div class="flex flex-col lg:flex-row h-full w-full fade-in overflow-hidden">
            <div class="lg:hidden step-scroll-container flex-shrink-0" id="mobile-step-list"></div>
            <!-- Sidebar -->
            <div class="hidden lg:flex flex-col w-60 bg-white border-r border-slate-200 overflow-hidden shadow-sm flex-shrink-0 h-full z-20">
                <div class="p-4 sidebar-header flex justify-between items-start">
                    <div>
                        <div class="text-[10px] font-bold tracking-widest opacity-70 mb-1">GROUP</div>
                        <h2 class="text-lg font-bold" id="group-title-sidebar">第 1 組</h2>
                    </div>
                    <button onclick="app.loadDashboard()" class="text-xs bg-white/10 hover:bg-white/20 border border-white/20 px-2 py-1 rounded text-white transition flex items-center gap-1"><i class="fa-solid fa-arrow-left"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto" id="desktop-step-list"></div>
            </div>
            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col bg-white h-full relative overflow-hidden">
                <!-- Top Bar -->
                <div class="px-6 py-4 border-b border-slate-100 bg-white flex-shrink-0 flex justify-between items-center z-10 shadow-sm">
                    <div>
                        <div class="lg:hidden mb-1"><button onclick="app.loadDashboard()" class="text-xs font-bold text-slate-400 flex items-center gap-1"><i class="fa-solid fa-arrow-left"></i> 回總表</button></div>
                        <h2 class="text-2xl font-bold text-slate-800 leading-tight" id="current-step-title"></h2>
                        <p class="text-sm text-slate-500" id="current-step-desc"></p>
                    </div>
                    <!-- Action Button (Desktop) -->
                    <div class="hidden lg:block">
                        <button id="next-step-btn-desktop" class="bg-teal-600 text-white px-6 py-2.5 rounded-lg font-bold shadow-md hover:bg-teal-700 transition flex items-center gap-2 text-base">下一步 <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Content Scroll Area -->
                <div class="flex-1 overflow-y-auto p-6 bg-slate-50/50" id="step-content"></div>
                
                <!-- Mobile Action Bar -->
                <div class="mobile-action-bar lg:hidden flex-shrink-0">
                     <button id="next-step-btn-mobile" class="w-full bg-teal-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-teal-600/20 active:scale-95 transition flex items-center justify-center gap-2 text-lg">下一步 <i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </template>

    <!-- 3. REMEDIATION GROUP VIEW -->
    <template id="tpl-remediation-group">
        <div class="w-full h-full flex flex-col fade-in overflow-hidden">
            <!-- Header Area -->
            <div class="bg-white px-6 py-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0 shadow-sm z-10">
                <div class="flex items-center gap-4">
                    <button onclick="app.loadDashboard()" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 flex-shrink-0 transition">
                        <i class="fa-solid fa-arrow-left text-base"></i>
                    </button>
                    <div>
                        <h2 class="font-bold text-slate-800 text-xl" id="rem-group-title">第 1 組計畫</h2>
                        <p class="text-xs text-slate-500 font-medium">Remediation Planning</p>
                    </div>
                </div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar" id="rem-tabs-container"></div>
            </div>
            
            <div class="flex-1 bg-slate-50 overflow-y-auto p-4 lg:p-6 flex flex-col">
                <!-- CCC Reference Block (Collapsible style) -->
                <div class="mb-6 bg-white border border-indigo-100 rounded-xl shadow-sm p-5 relative flex-shrink-0">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-indigo-500 rounded-l-xl"></div>
                    <h3 class="font-bold text-slate-700 text-lg mb-4 flex items-center gap-2"><i class="fa-solid fa-circle-info text-indigo-500"></i> CCC 參考資訊</h3>
                    <div id="rem-ccc-reference"></div>
                </div>

                <!-- Table Container -->
                <div class="bg-white rounded-xl shadow border border-slate-200 flex-1 flex flex-col overflow-hidden min-h-[400px]">
                    <div class="p-4 border-b border-slate-200 bg-white flex justify-between items-center flex-shrink-0">
                        <h4 class="font-bold text-slate-800 flex items-center gap-2 text-lg">
                            <i class="fa-solid fa-list-check text-blue-500"></i> 補強計畫表
                        </h4>
                        <button onclick="app.addRemediationRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> 新增項目
                        </button>
                    </div>
                    
                    <!-- Desktop Table View -->
                    <div class="hidden lg:block overflow-auto flex-1">
                        <table class="w-full rem-table min-w-[1200px]">
                            <thead class="sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="w-[20%]">缺失/問題</th>
                                    <th class="w-[15%]">核心能力</th>
                                    <th class="w-[20%]">行動計畫</th>
                                    <th class="w-[15%]">評量方法</th>
                                    <th class="w-[15%]">目標</th>
                                    <th class="w-[10%]">期限</th>
                                    <th class="w-[5%]"></th>
                                </tr>
                            </thead>
                            <tbody id="rem-table-body-desktop"></tbody>
                        </table>
                    </div>

                    <!-- Mobile Card View -->
                    <div class="lg:hidden p-4 space-y-4 overflow-y-auto flex-1" id="rem-list-mobile"></div>

                    <div id="rem-empty-state" class="text-center py-20 hidden bg-slate-50/50 flex-1 flex flex-col justify-center items-center">
                        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 text-slate-300 text-3xl shadow-sm border border-slate-100">
                            <i class="fa-solid fa-clipboard-question"></i>
                        </div>
                        <p class="text-slate-500 font-medium">尚無計畫內容，請點擊右上角新增</p>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="bg-white border-t border-slate-200 p-4 flex justify-end gap-4 flex-shrink-0 z-20">
                <button onclick="app.completeRemediation()" class="w-full lg:w-auto bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-600/20 hover:bg-indigo-700 transition flex items-center justify-center gap-2 text-lg">
                    提交計畫 <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </template>

    <!-- 4. ADAPT GROUP VIEW -->
    <template id="tpl-adapt-group">
        <div class="w-full h-full flex flex-col fade-in overflow-hidden">
            <!-- Header Area -->
            <div class="bg-white px-6 py-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0 shadow-sm z-10">
                <div class="flex items-center gap-4">
                    <button onclick="app.loadDashboard()" class="w-9 h-9 rounded-full border border-slate-200 flex items-center justify-center text-slate-500 hover:bg-slate-50 flex-shrink-0 transition">
                        <i class="fa-solid fa-arrow-left text-base"></i>
                    </button>
                    <div>
                        <h2 class="font-bold text-slate-800 text-xl" id="adapt-group-title">第 1 組 ADAPT</h2>
                        <p class="text-xs text-slate-500 font-medium">Feedback & Coaching</p>
                    </div>
                </div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar" id="adapt-tabs-container"></div>
            </div>
            
            <div class="flex-1 bg-slate-50 overflow-y-auto p-4 lg:p-8">
                <div class="space-y-6 max-w-5xl mx-auto" id="adapt-content"></div>
            </div>

            <!-- Footer Actions -->
            <div class="bg-white border-t border-slate-200 p-4 flex justify-end gap-4 flex-shrink-0 z-20">
                 <button onclick="app.completeAdapt()" class="w-full lg:w-auto bg-adapt hover-bg-adapt text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-[#ed7d31]/20 transition flex items-center justify-center gap-2 text-lg">
                    提交 ADAPT 紀錄 <i class="fa-solid fa-check-circle"></i>
                 </button>
            </div>
        </div>
    </template>

    <script>
        /* --- CONFIGURATION --- */
        const API_URL = "https://script.google.com/macros/s/AKfycbz-itROdnBGhhk0Ii7btFXFhV50B7846V0F5shjvm8Z4vcbh6r0UsRSieSpn0bW-CEztQ/exec"; 

        const CCC_STEPS = [
            { id: 1, title: "角色分配", duration: 5, desc: "確認委員會成員角色職責", label: "STEP 1" },
            { id: 2, title: "查閱學習歷程", duration: 10, desc: "檢視學員 PGY 學習檔案", label: "STEP 2" },
            { id: 3, title: "主席摘要", duration: 5, desc: "主席報告學員表現重點", label: "STEP 3" },
            { id: 4, title: "品質面向討論", duration: 20, desc: "ARICH 品質面向深入討論", label: "STEP 4" },
            { id: 5, title: "信賴決策與輔導", duration: 20, desc: "進行信賴決策與輔導計畫", label: "STEP 5" },
            { id: 6, title: "會議紀錄", duration: 20, desc: "紀錄討論共識與重點", label: "紀錄專區" }, 
            { id: 7, title: "觀察員紀錄", duration: 0, desc: "觀察員填寫回饋表單", label: "觀察員專區" }
        ];

        const ADAPT_STEPS = [
            { id: 'A1', label: 'A - Ask (詢問自評)', desc: '詢問學員對自己表現的看法，引導自我反思。' },
            { id: 'D',  label: 'D - Discuss (討論觀點)', desc: '針對具體行為進行討論，確認雙方認知一致。' },
            { id: 'A2', label: 'A - Ask (詢問理解)', desc: '詢問學員對問題的理解或解決方案的想法。' },
            { id: 'P',  label: 'P - Plan (擬定計畫)', desc: '共同制定具體可行的改善計畫。' },
            { id: 'T',  label: 'T - Teach (重點教學)', desc: '給予關鍵知識點或技巧指導 (Teachable moment)。' }
        ];

        const ROLES = [
            { name: "CCC主席", count: 1, icon: "fa-gavel", desc: "經驗豐富的PGY資深臨床教師，熟悉訓練計畫。任務是促進討論、統整觀點並引導決策流程。需確保各方意見被充分聆聽，營造安全開放氛圍，協助建立共識並提出總結性建議。" },
            { name: "護理部教學負責人", count: 1, icon: "fa-clipboard-user", desc: "任職滿10年，透過教學系統掌握每位學員狀況。雖未直接共事，但知悉兩位學員皆發生異常事件，且臨床端已對其提出回饋。" },
            { name: "病房資深臨床教師", count: 1, icon: "fa-user-tie", desc: "20年經驗，負責臨床學習與生活輔導。肯定王大明的知識與效率，但擔憂其團隊連結，要求完成改善計畫才予通過；認為李小美穩健但保守，傾向建議讓她進入下一階段。" },
            { name: "病房護理長", count: 1, icon: "fa-user-nurse", desc: "任職逾10年，重視規範落實。認為王大明雖主動但有規範遵循警訊，未見改善證據前難以信賴；肯定李小美認真可靠、交班完整，能力值得肯定。" },
            { name: "病房新任臨床教師", count: 1, icon: "fa-id-badge", desc: "新加入的指導教師（學姐）。首次參與CCC。認為王大明技術優但互動較命令式，能力足以授權；認為李小美動機強但能力尚未達預期，建議多給時間學習。" },
            { name: "觀察員", count: "N", icon: "fa-eye", desc: "請依「臨床能力委員會討論過程-觀察表」客觀旁觀並紀錄：會議流程、委員發言重點與決策形成過程。會後請回饋所觀察到的優勢與可改進之處。" }
        ];

        const OBSERVER_ITEMS = {
            "會議程序": ["主席有說明會議的目的與重點", "適當引導發言順序為「由幼至長」", "討論的過程展現意見的「多樣性」", "意見衝突時的處理機制"],
            "決策過程": ["決策考慮學員的專業素養 (ARICH)", "決策主要依據具體之「客觀事證」", "不受限於「階級」與「和諧」之框架", "達到「共享心智模式」之師培目的"]
        };

        const ARICH_CATS = [
            { id: 'integrity', label: '誠信', icon: 'fa-scale-balanced', desc: '誠實面對錯誤、仁慈' },
            { id: 'reliability', label: '可靠性', icon: 'fa-shield-halved', desc: '盡責、情緒穩定' },
            { id: 'humility', label: '謙遜', icon: 'fa-hand-holding-hand', desc: '辨識限制、主動求助' },
            { id: 'agency', label: '行動力', icon: 'fa-person-running', desc: '積極主動' }
        ];

        class App {
            constructor() {
                this.currentModule = 'ccc';
                this.groups = Array.from({ length: 8 }, (_, i) => ({
                    id: i + 1,
                    cccStep: 0, cccCompleted: false, remCompleted: false, adaptCompleted: false,
                    students: {
                        daming: { name: "王大明", result: null, reason: "", plan: "", summary: "", qualityNote: "", meetingNote: "", remediationPlan: [], adaptLog: {} },
                        xiaomei: { name: "李小美", result: null, reason: "", plan: "", summary: "", qualityNote: "", meetingNote: "", remediationPlan: [], adaptLog: {} }
                    },
                    activeStudentTab: 'daming', observerData: {}
                }));
                this.activeGroupId = null;
                this.secondsElapsed = 0;
                this.initTimer();
                this.switchModule('ccc');
                
                // On Init, Fetch Data
                this.fetchDataFromGoogleSheet();
            }

            initTimer() {
                setInterval(() => {
                    this.secondsElapsed++;
                    const min = Math.floor(this.secondsElapsed / 60).toString().padStart(2, '0');
                    const sec = (this.secondsElapsed % 60).toString().padStart(2, '0');
                    document.getElementById('global-timer').innerText = `${min}:${sec}`;
                }, 1000);
            }

            // Auto-resize textarea helper
            autoResize(el) {
                el.style.height = 'auto';
                el.style.height = (el.scrollHeight) + 'px';
            }

            switchModule(mod) {
                this.currentModule = mod;
                this.activeGroupId = null;
                
                // Reset Classes
                ['ccc', 'remediation', 'adapt'].forEach(m => {
                    const el = document.getElementById(`tab-${m}`);
                    if(m === mod) {
                        el.classList.add('active');
                        // Dynamic Color per module
                        if(mod === 'ccc') { el.classList.add('text-teal-700', 'border-teal-600'); document.documentElement.style.setProperty('--primary-color', '#0d9488'); }
                        if(mod === 'remediation') { el.classList.add('text-indigo-700', 'border-indigo-600'); document.documentElement.style.setProperty('--primary-color', '#4f46e5'); }
                        if(mod === 'adapt') { el.classList.add('text-adapt', 'border-adapt'); document.documentElement.style.setProperty('--primary-color', '#ed7d31'); }
                    } else {
                        el.classList.remove('active', 'text-teal-700', 'border-teal-600', 'text-indigo-700', 'border-indigo-600', 'text-adapt', 'border-adapt');
                        el.classList.add('text-slate-500');
                    }
                });

                const icon = document.getElementById('app-icon');
                if(mod === 'ccc') icon.className = `w-10 h-10 rounded-lg bg-teal-600 text-white flex items-center justify-center shadow-sm`;
                if(mod === 'remediation') icon.className = `w-10 h-10 rounded-lg bg-indigo-600 text-white flex items-center justify-center shadow-sm`;
                if(mod === 'adapt') icon.className = `w-10 h-10 rounded-lg bg-adapt text-white flex items-center justify-center shadow-sm`;

                this.loadDashboard();
            }

            loadDashboard() {
                this.activeGroupId = null;
                const tpl = document.getElementById('tpl-dashboard');
                const container = document.getElementById('main-container');
                container.innerHTML = '';
                container.appendChild(tpl.content.cloneNode(true));
                container.scrollTop = 0;

                const titleEl = document.getElementById('dashboard-title');
                const descEl = document.getElementById('dashboard-desc');
                const titleClass = document.getElementById('dashboard-title').classList;
                
                // Clear prev title colors
                titleClass.remove('text-teal-900', 'text-indigo-900', 'text-adapt');

                if(this.currentModule === 'ccc') {
                    titleEl.innerText = "CCC 臨床能力委員會演練";
                    descEl.innerText = "即時監控 8 個小組的討論進度與決策結果";
                    titleClass.add('text-teal-900');
                } else if(this.currentModule === 'remediation') {
                    titleEl.innerText = "補強計畫設計演練";
                    descEl.innerText = "針對學員缺失設計具體行動方案";
                    titleClass.add('text-indigo-900');
                } else {
                    titleEl.innerText = "ADAPT 回饋模組演練";
                    descEl.innerText = "紀錄回饋流程是否順暢";
                    titleClass.add('text-adapt');
                }

                const grid = document.getElementById('dashboard-grid');
                this.groups.forEach(g => grid.appendChild(this.createCard(g)));
            }

            createCard(g) {
                const div = document.createElement('div');
                div.className = "dashboard-card cursor-pointer group";
                div.onclick = () => this.loadGroup(g.id);
                
                let progress = 0, statusColor = "bg-slate-300", statusText = "未開始", barColor = "";

                if(this.currentModule === 'ccc') {
                    barColor = "bg-teal-500";
                    if (g.cccCompleted) { progress = 100; statusColor = "bg-green-500"; statusText = "已完成"; } 
                    else if (g.cccStep > 0 || this.hasEnteredData(g)) { progress = Math.min(90, (g.cccStep / 6) * 100); statusColor = "bg-yellow-400"; statusText = "進行中"; }
                } else if(this.currentModule === 'remediation') {
                    barColor = "bg-indigo-500";
                    if (g.remCompleted) { progress = 100; statusColor = "bg-green-500"; statusText = "完成"; }
                    else if (g.students.daming.remediationPlan.length > 0 || g.students.xiaomei.remediationPlan.length > 0) { progress = 50; statusColor = "bg-yellow-400"; statusText = "進行中"; }
                } else {
                    barColor = "bg-adapt";
                    if (g.adaptCompleted) { progress = 100; statusColor = "bg-green-500"; statusText = "完成"; }
                    else if (Object.keys(g.students.daming.adaptLog).length > 0 || Object.keys(g.students.xiaomei.adaptLog).length > 0) { progress = 50; statusColor = "bg-yellow-400"; statusText = "進行中"; }
                }

                div.innerHTML = `
                    <div class="p-6 md:p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-2xl text-slate-800">第 ${g.id} 組</h3>
                            <div class="flex items-center gap-2 text-sm font-bold text-slate-500"><span class="w-3 h-3 rounded-full ${statusColor}"></span> ${statusText}</div>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-3 mb-6 overflow-hidden"><div class="h-full ${barColor} transition-all duration-500" style="width: ${progress}%"></div></div>
                        <div class="text-base text-slate-400 flex justify-between items-center">
                            <span>${this.currentModule==='ccc'?(g.cccCompleted?'演練結束':`Step ${g.cccStep}`):(this.currentModule==='remediation'?'計畫填寫':'回饋紀錄')}</span>
                            <i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-slate-600 transition-colors text-lg"></i>
                        </div>
                    </div>`;
                return div;
            }
            
            hasEnteredData(group) { const s1=group.students.daming; const s2=group.students.xiaomei; return s1.summary||s1.reason||s1.plan||s1.qualityNote||s1.meetingNote||s1.result!==null || s2.summary||s2.reason||s2.plan||s2.qualityNote||s2.meetingNote||s2.result!==null; }

            loadGroup(id) {
                this.activeGroupId = id;
                const container = document.getElementById('main-container');
                container.innerHTML = '';
                container.scrollTop = 0;
                if (this.currentModule === 'ccc') {
                    const tpl = document.getElementById('tpl-ccc-group');
                    container.appendChild(tpl.content.cloneNode(true));
                    this.renderCCC();
                } else if (this.currentModule === 'remediation') {
                    const tpl = document.getElementById('tpl-remediation-group');
                    container.appendChild(tpl.content.cloneNode(true));
                    this.renderRemediation();
                } else {
                    const tpl = document.getElementById('tpl-adapt-group');
                    container.appendChild(tpl.content.cloneNode(true));
                    this.renderAdapt();
                }
            }

            renderCCC() {
                const g = this.groups[this.activeGroupId - 1];
                document.getElementById('group-title-sidebar').innerText = `第 ${g.id} 組`;
                const renderSteps = (containerId, isMobile) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    CCC_STEPS.forEach((s, i) => {
                        const isActive = i === g.cccStep;
                        const el = document.createElement('div');
                        if (isMobile) { el.className = `step-pill ${isActive ? 'active' : ''}`; el.innerText = `${i+1}. ${s.title}`; } 
                        else { el.className = `sidebar-item ${isActive ? 'active' : ''}`; el.innerHTML = `<div class="label">${s.label}</div><div class="title">${s.title}</div>`; }
                        el.onclick = () => { g.cccStep = i; this.renderCCC(); };
                        container.appendChild(el);
                    });
                };
                renderSteps('mobile-step-list', true);
                renderSteps('desktop-step-list', false);

                const step = CCC_STEPS[g.cccStep];
                document.getElementById('current-step-title').innerText = step.title;
                document.getElementById('current-step-desc').innerText = step.desc;
                document.getElementById('step-content').innerHTML = this.getCCCContentHTML(g.cccStep + 1);

                // Handle Buttons
                const btnText = (g.cccStep === 6) ? '返回儀表板' : (g.cccStep === 5) ? '完成演練' : '下一步 <i class="fa-solid fa-arrow-right ml-2"></i>';
                // Trigger auto-save on next
                const btnAction = (g.cccStep === 6) ? () => this.loadDashboard() : (g.cccStep === 5) ? () => this.completeCCCGroupSimulation() : () => { 
                    g.cccStep++; 
                    this.renderCCC(); 
                    this.sendDataToGoogleSheet(g, 'ccc');
                };
                
                const btnDesktop = document.getElementById('next-step-btn-desktop');
                const btnMobile = document.getElementById('next-step-btn-mobile');
                
                if (btnDesktop) { btnDesktop.innerHTML = btnText; btnDesktop.onclick = btnAction; }
                if (btnMobile) { btnMobile.innerHTML = btnText; btnMobile.onclick = btnAction; }
            }

            getTabsHTML(activeKey, showLabel = false) {
                const labelPrefix = showLabel ? "" : "";
                const commonBtn = "px-6 py-2 rounded-t-lg font-bold transition-all text-base flex-1 md:flex-none flex items-center justify-center border-b-0";
                const damingActive = "bg-blue-600 text-white shadow-md transform -translate-y-1"; 
                const xiaomeiActive = "bg-pink-600 text-white shadow-md transform -translate-y-1";
                const inactive = "bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700";
                return `<div class="flex gap-2 border-b border-slate-200 mb-0 px-0 pt-2"><button onclick="app.switchStudentTab('daming')" class="${commonBtn} ${activeKey==='daming' ? damingActive : inactive}"><i class="fa-solid fa-user-nurse mr-2"></i> ${labelPrefix}王大明</button><button onclick="app.switchStudentTab('xiaomei')" class="${commonBtn} ${activeKey==='xiaomei' ? xiaomeiActive : inactive}"><i class="fa-solid fa-user-nurse mr-2"></i> ${labelPrefix}李小美</button></div>`;
            }

            getCCCContentHTML(stepId) {
                const g = this.groups[this.activeGroupId - 1];
                const activeKey = g.activeStudentTab;
                
                if (stepId === 1) return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${ROLES.map(r => `<div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center"><i class="fa-solid ${r.icon} text-lg"></i></div><div><h4 class="font-bold text-slate-800 text-base">${r.name}</h4><span class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">人數: ${r.count}</span></div></div><p class="text-sm text-slate-600 leading-relaxed">${r.desc}</p></div>`).join('')}</div>`;
                if (stepId === 2) return `<div class="flex flex-col items-center justify-center h-full"><div class="text-center py-6 bg-white rounded-2xl border border-slate-200 shadow-sm w-full max-w-4xl"><div class="flex justify-center mb-4"><i class="fa-solid fa-book-open text-6xl text-slate-200"></i></div><h3 class="text-xl font-bold text-slate-700 mb-2">請參閱學習歷程檔案</h3><p class="text-slate-500 mb-6 text-sm">請委員參閱紙本或平板資料</p><div class="flex justify-center gap-4"><button class="px-6 py-2.5 rounded-lg border-2 border-blue-100 font-bold text-blue-700 bg-blue-50 shadow-sm hover:bg-blue-100 transition text-base flex items-center gap-2" onclick="window.open('https://drive.google.com/file/d/1kFyY6sXyQqTZZauE3kU75CHUx_a9SViC/view?usp=drive_link','_blank')"><i class="fa-regular fa-folder-open"></i> 王大明資料</button><button class="px-6 py-2.5 rounded-lg border-2 border-pink-100 font-bold text-pink-700 bg-pink-50 shadow-sm hover:bg-pink-100 transition text-base flex items-center gap-2" onclick="window.open('https://drive.google.com/file/d/1DpmGdfgwJRTxE7sSLwUB6wvR5Mep_Abu/view?usp=drive_link','_blank')"><i class="fa-regular fa-folder-open"></i> 李小美資料</button></div></div></div>`;
                
                // Optimized Step 3: Full Height Input
                if (stepId === 3) return `<div class="flex flex-col h-full bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div class="bg-white px-6 border-b border-slate-200">${this.getTabsHTML(activeKey)}</div><div class="flex-1 p-0 relative"><textarea class="textarea-fill w-full p-6 text-lg focus:ring-0 border-0" placeholder="請在此輸入學員的主席摘要..." oninput="app.updateInput('${activeKey}','summary',this.value)">${g.students[activeKey].summary}</textarea></div></div>`;
                
                // Optimized Step 4: Compact Grid + Full Height Input
                if (stepId === 4) return `<div class="flex flex-col h-full gap-4"><div class="grid grid-cols-4 gap-4 flex-shrink-0">${ARICH_CATS.map(cat => `<div class="bg-white p-3 rounded-xl border border-slate-200 text-center shadow-sm"><div class="w-8 h-8 mx-auto rounded-full bg-teal-50 text-teal-600 flex items-center justify-center text-sm mb-1"><i class="fa-solid ${cat.icon}"></i></div><div class="font-bold text-slate-800 text-sm">${cat.label}</div></div>`).join('')}</div><div class="flex flex-col flex-1 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div class="bg-white px-6 border-b border-slate-200">${this.getTabsHTML(activeKey)}</div><div class="flex-1 p-0 relative"><textarea class="textarea-fill w-full p-6 text-lg focus:ring-0 border-0" placeholder="請記錄品質面向討論內容..." oninput="app.updateInput('${activeKey}', 'qualityNote', this.value)">${g.students[activeKey].qualityNote}</textarea></div></div></div>`;
                
                // Optimized Step 5: Decision & Plan (Split View)
                if (stepId === 5) { const s = g.students[activeKey]; return `<div class="flex flex-col h-full bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div class="bg-white px-6 border-b border-slate-200">${this.getTabsHTML(activeKey)}</div><div class="p-6 border-b border-slate-100 flex-shrink-0"><div class="flex items-center gap-4"><h4 class="font-bold text-slate-800 text-lg">信賴決策結果：</h4><div class="flex gap-3 flex-1"><button class="flex-1 py-3 rounded-lg border-2 font-bold text-lg transition ${s.result===true?'border-green-500 bg-green-50 text-green-700':'border-slate-200 text-slate-400 hover:border-slate-300'}" onclick="app.setResult(true)">PASS 可信賴</button><button class="flex-1 py-3 rounded-lg border-2 font-bold text-lg transition ${s.result===false?'border-red-500 bg-red-50 text-red-700':'border-slate-200 text-slate-400 hover:border-slate-300'}" onclick="app.setResult(false)">FAIL 未通過</button></div></div></div><div class="flex-1 grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-slate-100"><div class="flex flex-col"><div class="bg-slate-50 px-4 py-2 text-sm font-bold text-slate-500 border-b border-slate-100">決策原因</div><textarea class="textarea-fill w-full p-4 border-0 focus:ring-0" placeholder="請說明原因..." oninput="app.updateInput('${activeKey}','reason',this.value)">${s.reason}</textarea></div><div class="flex flex-col"><div class="bg-slate-50 px-4 py-2 text-sm font-bold text-slate-500 border-b border-slate-100">輔導方案</div><textarea class="textarea-fill w-full p-4 border-0 focus:ring-0" placeholder="請輸入輔導計畫..." oninput="app.updateInput('${activeKey}','plan',this.value)">${s.plan}</textarea></div></div></div>`; }
                
                // Optimized Step 6: Full Height Input
                if (stepId === 6) return `<div class="flex flex-col h-full bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div class="bg-white px-6 border-b border-slate-200">${this.getTabsHTML(activeKey)}</div><div class="flex-1 p-0 relative"><textarea class="textarea-fill w-full p-6 text-lg focus:ring-0 border-0" placeholder="請輸入會議紀錄與共識..." oninput="app.updateInput('${activeKey}','meetingNote',this.value)">${g.students[activeKey].meetingNote}</textarea></div></div>`;
                
                // Optimized Step 7: Split View (Side by Side)
                if (stepId === 7) return `<div class="flex flex-col h-full bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div class="bg-white px-6 border-b border-slate-200">${this.getTabsHTML(activeKey)}</div><div class="flex-1 grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-slate-200 overflow-hidden">${Object.entries(OBSERVER_ITEMS).map(([category, items], catIdx) => `<div class="flex flex-col h-full overflow-hidden"><div class="p-4 bg-slate-50 border-b border-slate-100 flex-shrink-0"><h5 class="font-bold text-slate-800 text-base mb-2 flex items-center gap-2"><span class="bg-white border border-slate-200 w-6 h-6 flex items-center justify-center rounded text-xs">${catIdx+1}</span> ${category}</h5><ul class="list-disc pl-5 text-xs text-slate-500 space-y-0.5">${items.map(i => `<li>${i}</li>`).join('')}</ul></div><div class="flex-1 flex flex-col min-h-0"><div class="flex-1 flex flex-col border-b border-slate-100"><div class="px-4 py-2 bg-white text-xs font-bold text-teal-600">實際觀察</div><textarea class="flex-1 w-full p-4 text-base border-0 focus:ring-0 resize-none" placeholder="請描述..." oninput="app.updateObs('${activeKey}', '${category}-actual', this.value)">${g.observerData[`${activeKey}-${category}-actual`] || ''}</textarea></div><div class="flex-1 flex flex-col"><div class="px-4 py-2 bg-white text-xs font-bold text-orange-500">挑戰與限制</div><textarea class="flex-1 w-full p-4 text-base border-0 focus:ring-0 resize-none" placeholder="請描述..." oninput="app.updateObs('${activeKey}', '${category}-limit', this.value)">${g.observerData[`${activeKey}-${category}-limit`] || ''}</textarea></div></div></div>`).join('')}</div></div>`;
            }

            renderRemediation() {
                const g = this.groups[this.activeGroupId - 1];
                const key = g.activeStudentTab;
                const damingBtn = `<button onclick="app.switchStudentTab('daming')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${key==='daming' ? 'bg-blue-600 text-white shadow' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">王大明</button>`;
                const xiaomeiBtn = `<button onclick="app.switchStudentTab('xiaomei')" class="px-4 py-2 rounded-lg text-sm font-bold transition-all ${key==='xiaomei' ? 'bg-pink-600 text-white shadow' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">李小美</button>`;
                
                const remTabsContainer = document.getElementById('rem-tabs-container');
                if (remTabsContainer) remTabsContainer.innerHTML = damingBtn + xiaomeiBtn;
                
                const remGroupTitle = document.getElementById('rem-group-title');
                if (remGroupTitle) remGroupTitle.innerText = `第 ${g.id} 組計畫`;
                
                const s = g.students[key];
                const resultBadge = s.result === true ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold border border-green-200">PASS</span>' : s.result === false ? '<span class="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-bold border border-red-200">FAIL</span>' : '<span class="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-xs font-bold border border-slate-200">未定</span>';
                
                const refHTML = `<div class="flex items-center gap-3 mb-2"><span class="text-sm font-bold text-slate-500">CCC 決策：</span>${resultBadge}</div><div class="text-sm text-slate-600 grid grid-cols-2 gap-4"><div class="bg-slate-50 p-3 rounded border border-slate-100"><div class="font-bold mb-1 text-xs text-slate-400">原因</div>${s.reason || '-'}</div><div class="bg-slate-50 p-3 rounded border border-slate-100"><div class="font-bold mb-1 text-xs text-slate-400">輔導</div>${s.plan || '-'}</div></div>`;
                
                const cccRefContainer = document.getElementById('rem-ccc-reference');
                if (cccRefContainer) cccRefContainer.innerHTML = refHTML;
                
                // Desktop Table
                const containerDesktop = document.getElementById('rem-table-body-desktop');
                if (containerDesktop) {
                    containerDesktop.innerHTML = '';
                    s.remediationPlan.forEach((item, idx) => {
                        const tr = document.createElement('tr');
                        tr.className = "group hover:bg-slate-50 transition-colors";
                        tr.innerHTML = `<td><textarea class="bg-white focus:bg-indigo-50/30 p-2 border-slate-200 rounded text-sm w-full" oninput="app.updateRemRow(${idx},'deficit',this.value)">${item.deficit}</textarea></td><td><textarea class="bg-white focus:bg-indigo-50/30 p-2 border-slate-200 rounded text-sm w-full" oninput="app.updateRemRow(${idx},'competency',this.value)">${item.competency}</textarea></td><td><textarea class="bg-white focus:bg-indigo-50/30 p-2 border-slate-200 rounded text-sm w-full" oninput="app.updateRemRow(${idx},'action',this.value)">${item.action}</textarea></td><td><textarea class="bg-white focus:bg-indigo-50/30 p-2 border-slate-200 rounded text-sm w-full" oninput="app.updateRemRow(${idx},'assessment',this.value)">${item.assessment}</textarea></td><td><textarea class="bg-white focus:bg-indigo-50/30 p-2 border-slate-200 rounded text-sm w-full" oninput="app.updateRemRow(${idx},'goal',this.value)">${item.goal}</textarea></td><td><textarea class="bg-white focus:bg-indigo-50/30 p-2 border-slate-200 rounded text-sm w-full" oninput="app.updateRemRow(${idx},'deadline',this.value)">${item.deadline}</textarea></td><td class="align-middle text-center"><button onclick="app.deleteRemRow(${idx})" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>`;
                        containerDesktop.appendChild(tr);
                    });
                }

                // Mobile Cards
                const containerMobile = document.getElementById('rem-list-mobile');
                if (containerMobile) {
                    containerMobile.innerHTML = '';
                    s.remediationPlan.forEach((item, idx) => {
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm";
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                                <span class="font-bold text-indigo-600 text-sm">項目 ${idx + 1}</span>
                                <button onclick="app.deleteRemRow(${idx})" class="text-red-400 hover:text-red-600 text-sm"><i class="fa-solid fa-trash-can"></i> 刪除</button>
                            </div>
                            <div class="space-y-3">
                                <div><label class="text-xs font-bold text-slate-400 block mb-1">缺失/問題</label><textarea class="w-full p-2 border border-slate-200 rounded text-sm" oninput="app.updateRemRow(${idx},'deficit',this.value)">${item.deficit}</textarea></div>
                                <div><label class="text-xs font-bold text-slate-400 block mb-1">行動計畫</label><textarea class="w-full p-2 border border-slate-200 rounded text-sm" oninput="app.updateRemRow(${idx},'action',this.value)">${item.action}</textarea></div>
                            </div>
                        `;
                        containerMobile.appendChild(card);
                    });
                }

                // Empty State Logic
                const emptyState = document.getElementById('rem-empty-state');
                if (s.remediationPlan.length === 0) { 
                    if (emptyState) emptyState.classList.remove('hidden');
                    if (containerDesktop) containerDesktop.parentElement.classList.add('hidden'); 
                } else {
                    if (emptyState) emptyState.classList.add('hidden');
                    if (containerDesktop) containerDesktop.parentElement.classList.remove('hidden');
                }
            }

            renderAdapt() {
                const g = this.groups[this.activeGroupId - 1];
                const key = g.activeStudentTab;
                const damingBtn = `<button onclick="app.switchStudentTab('daming')" class="px-8 py-3.5 rounded-t-xl font-bold transition-all text-lg flex-1 md:flex-none flex items-center justify-center border-b-0 ${key==='daming' ? 'bg-adapt text-white shadow-md transform -translate-y-1' : 'bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700'}"><i class="fa-solid fa-user-nurse mr-2"></i> 王大明</button>`;
                const xiaomeiBtn = `<button onclick="app.switchStudentTab('xiaomei')" class="px-8 py-3.5 rounded-t-xl font-bold transition-all text-lg flex-1 md:flex-none flex items-center justify-center border-b-0 ${key==='xiaomei' ? 'bg-adapt text-white shadow-md transform -translate-y-1' : 'bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-700'}"><i class="fa-solid fa-user-nurse mr-2"></i> 李小美</button>`;
                
                const tabsContainer = document.getElementById('adapt-tabs-container');
                if (tabsContainer) tabsContainer.innerHTML = damingBtn + xiaomeiBtn;
                
                document.getElementById('adapt-group-title').innerText = `第 ${g.id} 組 ADAPT`;
                const container = document.getElementById('adapt-content');
                const s = g.students[key];
                let html = '';
                ADAPT_STEPS.forEach((step, idx) => {
                    const isSmooth = s.adaptLog[`${step.id}_smooth`];
                    const note = s.adaptLog[`${step.id}_note`] || '';
                    html += `<div class="bg-white border border-slate-200 rounded-xl p-8 shadow-sm hover:border-adapt transition"><div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4"><div><h4 class="font-bold text-slate-800 text-xl flex items-center gap-3"><span class="bg-adapt/10 text-adapt w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">${idx+1}</span> ${step.label}</h4><p class="text-slate-500 text-base mt-2 pl-11">${step.desc}</p></div><div class="flex items-center gap-4 pl-11 md:pl-0"><span class="text-base font-bold text-slate-500">落實與否</span><div class="flex gap-3"><button onclick="app.updateAdaptItem('${step.id}_smooth', true)" class="px-4 py-2 rounded-lg border ${isSmooth===true ? 'bg-green-500 text-white border-green-600' : 'bg-white text-slate-400 border-slate-200'} font-bold transition text-base">落實</button><button onclick="app.updateAdaptItem('${step.id}_smooth', false)" class="px-4 py-2 rounded-lg border ${isSmooth===false ? 'bg-red-500 text-white border-red-600' : 'bg-white text-slate-400 border-slate-200'} font-bold transition text-base">未落實</button></div></div></div><div class="pl-0 md:pl-11"><textarea class="w-full auto-expand bg-slate-50 focus:bg-white p-4 rounded-lg text-base border-slate-200" placeholder="觀察備註 (例如：學員反應、使用的問句...)" oninput="app.updateAdaptItem('${step.id}_note', this.value); app.autoResize(this)">${note}</textarea></div></div>`;
                });
                container.innerHTML = html;
                
                // Initialize resize for adapt items
                container.querySelectorAll('textarea').forEach(el => this.autoResize(el));
            }

            updateAdaptItem(field, value) {
                const g = this.groups[this.activeGroupId - 1];
                g.students[g.activeStudentTab].adaptLog[field] = value;
                if (typeof value === 'boolean') this.renderAdapt(); 
            }

            updateInput(student, field, value) { this.groups[this.activeGroupId - 1].students[student][field] = value; }
            updateData(student, field, value) { this.updateInput(student, field, value); }
            updateObs(key, value) { this.groups[this.activeGroupId - 1].observerData[key] = value; }
            setResult(r) { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].result = r; this.renderCCC(); }
            addRemediationRow() { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan.push({deficit:'',competency:'',action:'',assessment:'',goal:'',deadline:''}); this.renderRemediation(); }
            updateRemRow(index, field, value) { this.groups[this.activeGroupId - 1].students[this.groups[this.activeGroupId - 1].activeStudentTab].remediationPlan[index][field] = value; }
            deleteRemRow(index) { if(confirm('刪除此項目?')) { this.groups[this.activeGroupId-1].students[this.groups[this.activeGroupId-1].activeStudentTab].remediationPlan.splice(index,1); this.renderRemediation(); } }
            
            switchStudentTab(student) { 
                this.groups[this.activeGroupId - 1].activeStudentTab = student;
                if(this.currentModule === 'ccc') this.renderCCC();
                else if(this.currentModule === 'remediation') this.renderRemediation();
                else if(this.currentModule === 'adapt') this.renderAdapt();
            }

            closeModal() { document.getElementById('custom-modal').classList.add('hidden'); }
            
            showModal({ title, message, icon, type, onConfirm }) {
                const modal = document.getElementById('custom-modal');
                const titleEl = document.getElementById('modal-title');
                const msgEl = document.getElementById('modal-message');
                const iconContainer = document.getElementById('modal-icon');
                const btnCancel = document.getElementById('modal-btn-cancel');
                const btnConfirm = document.getElementById('modal-btn-confirm');
                titleEl.innerHTML = title;
                msgEl.innerHTML = message;
                
                if (type === 'success') { 
                    iconContainer.innerHTML = '<i class="fa-solid fa-check text-green-600 text-xl"></i>'; 
                    iconContainer.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4 shadow-sm"; 
                    btnConfirm.className = "bg-green-600 text-white hover:bg-green-700 flex-1 py-3 rounded-xl text-base font-bold shadow-lg transition"; 
                } 
                else if (type === 'warning') { 
                    iconContainer.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-yellow-600 text-xl"></i>'; 
                    iconContainer.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4 shadow-sm"; 
                    btnConfirm.className = "bg-yellow-600 text-white hover:bg-yellow-700 flex-1 py-3 rounded-xl text-base font-bold shadow-lg transition"; 
                }

                if (onConfirm) { 
                    btnCancel.classList.remove('hidden'); 
                    btnConfirm.onclick = () => { this.closeModal(); onConfirm(); }; 
                } else { 
                    btnCancel.classList.add('hidden'); 
                    btnConfirm.onclick = () => this.closeModal(); 
                }
                
                modal.classList.remove('hidden'); 
                setTimeout(() => { modal.classList.add('opacity-100'); modal.querySelector('#modal-content').classList.add('scale-100'); }, 10);
            }

            completeCCCGroupSimulation() {
                const group = this.groups[this.activeGroupId - 1];
                const p1 = group.students.daming.result;
                const p2 = group.students.xiaomei.result;
                if (p1 !== null && p2 !== null) { 
                    this.showModal({ 
                        title: "確認結束演練", 
                        message: "兩位學員皆已評定完成。<br>確定要結束本組演練並返回儀表板嗎？", 
                        type: 'success', 
                        onConfirm: () => { 
                            group.cccCompleted = true; 
                            group.cccStep = 6; 
                            this.sendDataToGoogleSheet(group, 'ccc'); 
                            this.loadDashboard(); 
                        } 
                    }); 
                } 
                else { 
                    this.showModal({ 
                        title: "無法結束演練", 
                        message: "請確認<span class='font-bold text-red-600'>兩位學員</span>皆已完成信賴決策(Pass/Fail)後再送出。", 
                        type: 'warning' 
                    }); 
                }
            }

            completeRemediation() {
                const group = this.groups[this.activeGroupId - 1];
                this.showModal({
                    title: "提交補強計畫",
                    message: "確定要提交本組的補強計畫嗎？<br><span class='text-sm text-slate-400'>提交後將標記為完成。</span>",
                    type: "success",
                    onConfirm: () => {
                        group.remCompleted = true;
                        this.sendDataToGoogleSheet(group, 'remediation');
                        this.loadDashboard();
                    }
                });
            }

            completeAdapt() {
                const group = this.groups[this.activeGroupId - 1];
                this.showModal({
                    title: "提交 ADAPT 回饋",
                    message: "確定要提交本組的回饋紀錄嗎？",
                    type: "success",
                    onConfirm: () => {
                        group.adaptCompleted = true;
                        this.sendDataToGoogleSheet(group, 'adapt');
                        this.loadDashboard();
                    }
                });
            }

            // --- 新增：讀取資料 ---
            fetchDataFromGoogleSheet() {
                console.log("Fetching data from Google Sheet...");
                document.getElementById('loading-overlay').style.display = 'flex';
                
                fetch(API_URL)
                .then(res => res.json())
                .then(resp => {
                    if (resp.result === 'success') {
                        this.processServerData(resp.data);
                    } else {
                        console.error('Server error:', resp);
                    }
                })
                .catch(err => console.error('Fetch error:', err))
                .finally(() => {
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => { 
                        document.getElementById('loading-overlay').style.display = 'none'; 
                    }, 300);
                });
            }

            processServerData(data) {
                // 清空本地計畫，避免重複 (先重置)
                this.groups.forEach(g => {
                    g.students.daming.remediationPlan = [];
                    g.students.xiaomei.remediationPlan = [];
                });

                // 1. Process CCC Data
                if (data.CCC_Master_Log) {
                    data.CCC_Master_Log.forEach(row => {
                        // row[1] = GroupID, row[2] = Name
                        const gid = parseInt(row[1]);
                        const name = row[2];
                        const studentKey = (name === "王大明") ? "daming" : (name === "李小美") ? "xiaomei" : null;
                        
                        if (gid && studentKey && this.groups[gid-1]) {
                            const s = this.groups[gid-1].students[studentKey];
                            s.summary = row[3];
                            s.qualityNote = row[4];
                            
                            // Parse Result
                            if (row[5] === "PASS") s.result = true;
                            else if (row[5] === "FAIL") s.result = false;
                            
                            s.reason = row[6];
                            s.plan = row[7];
                            s.meetingNote = row[8];
                            
                            // Parse Observer Log
                            try {
                                if (row[9]) {
                                    const obs = JSON.parse(row[9]);
                                    // Merge observer data
                                    Object.assign(this.groups[gid-1].observerData, obs);
                                }
                            } catch(e) { console.error("JSON parse error", e); }
                            
                            // Restore Step Logic from Status Column (row[10])
                            if(row[10]==="Completed") { 
                                this.groups[gid-1].cccCompleted=true; this.groups[gid-1].cccStep=6; 
                            } else if (typeof row[10] === 'string' && row[10].startsWith("Step ")) {
                                const stepNum = parseInt(row[10].split(" ")[1]);
                                if (!isNaN(stepNum)) {
                                    this.groups[gid-1].cccStep = stepNum;
                                }
                            }
                        }
                    });
                }

                // 2. Process Remediation Data
                if (data.Remediation_Details) {
                    data.Remediation_Details.forEach(row => {
                        const gid = parseInt(row[1]);
                        const name = row[2];
                        const studentKey = (name === "王大明") ? "daming" : (name === "李小美") ? "xiaomei" : null;
                        
                        if (gid && studentKey && this.groups[gid-1]) {
                            const s = this.groups[gid-1].students[studentKey];
                            s.remediationPlan.push({
                                deficit: row[3],
                                competency: row[4],
                                action: row[5],
                                assessment: row[6],
                                goal: row[7],
                                deadline: row[8]
                            });
                            // If data exists, mark partial/full complete status visually later
                            this.groups[gid-1].remCompleted = true; 
                        }
                    });
                }

                // 3. Process ADAPT Data
                if (data.ADAPT_Feedbeck_Log) {
                    data.ADAPT_Feedbeck_Log.forEach(row => {
                        const gid = parseInt(row[1]);
                        const name = row[2];
                        const studentKey = (name === "王大明") ? "daming" : (name === "李小美") ? "xiaomei" : null;
                        
                        if (gid && studentKey && this.groups[gid-1]) {
                            const s = this.groups[gid-1].students[studentKey];
                            
                            // Helper to parse "落實"/"未落實"
                            const parseSmooth = (val) => val === "落實" ? true : val === "未落實" ? false : null;
                            
                            s.adaptLog['A1_smooth'] = parseSmooth(row[3]);
                            s.adaptLog['A1_note'] = row[4];
                            
                            s.adaptLog['D_smooth'] = parseSmooth(row[5]);
                            s.adaptLog['D_note'] = row[6];
                            
                            s.adaptLog['A2_smooth'] = parseSmooth(row[7]);
                            s.adaptLog['A2_note'] = row[8];
                            
                            s.adaptLog['P_smooth'] = parseSmooth(row[9]);
                            s.adaptLog['P_note'] = row[10];
                            
                            s.adaptLog['T_smooth'] = parseSmooth(row[11]);
                            s.adaptLog['T_note'] = row[12];
                            
                            this.groups[gid-1].adaptCompleted = true;
                        }
                    });
                }
                
                // Refresh View
                this.loadDashboard();
            }

            // --- 寫入資料 (POST) ---
            sendDataToGoogleSheet(group, type) {
                let sheetName = "";
                let rows = [];
                const timestamp = new Date().toISOString();
                
                if (type === 'ccc') {
                    sheetName = "CCC_Master_Log";
                    ['daming', 'xiaomei'].forEach(key => {
                        const s = group.students[key];
                        // Dynamic Status Logic
                        let statusStr = "In Progress";
                        if (group.cccCompleted) {
                            statusStr = "Completed";
                        } else {
                            statusStr = `Step ${group.cccStep}`; 
                        }
                        
                        // JSON stringify observer data
                        const obsLog = JSON.stringify(group.observerData || {});

                        const row = [
                            timestamp, group.id, s.name,
                            s.summary, s.qualityNote,
                            (s.result === true ? "PASS" : (s.result === false ? "FAIL" : "")), 
                            s.reason, s.plan,
                            s.meetingNote, obsLog, statusStr
                        ];
                        rows.push(row);
                    });
                } else if (type === 'remediation') {
                    sheetName = "Remediation_Details";
                    ['daming', 'xiaomei'].forEach(key => {
                        const s = group.students[key];
                        s.remediationPlan.forEach(item => {
                             const row = [
                                timestamp, group.id, s.name,
                                item.deficit, item.competency, item.action,
                                item.assessment, item.goal, item.deadline
                            ];
                            rows.push(row);
                        });
                    });
                } else if (type === 'adapt') {
                     sheetName = "ADAPT_Feedbeck_Log"; 
                     ['daming', 'xiaomei'].forEach(key => {
                        const s = group.students[key];
                        const row = [timestamp, group.id, s.name];
                        ADAPT_STEPS.forEach(step => {
                            const smoothVal = s.adaptLog[`${step.id}_smooth`];
                            const noteVal = s.adaptLog[`${step.id}_note`] || "";
                            let smoothText = "";
                            if (smoothVal === true) smoothText = "落實";
                            else if (smoothVal === false) smoothText = "未落實";
                            row.push(smoothText);
                            row.push(noteVal);
                        });
                        rows.push(row);
                     });
                }

                if (rows.length === 0) return;

                const payload = { sheet: sheetName, data: rows };
                console.log("Sending Data:", payload);

                fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Success:", data);
                    if(data.result === 'error') alert("傳送失敗: " + data.error);
                    else {
                        // If it's a completion action, we might show a message or just log
                        console.log('Saved successfully');
                        if(type === 'ccc' && group.cccCompleted) {
                             // This is handled by the confirm modal callback, but good to have here too
                        }
                    }
                })
                .catch((error) => console.error('Error:', error));
            }
        }

        const app = new App();
    </script>
</body>
</html>
